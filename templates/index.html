{% extends "base.html" %}
{% block title %}–ö–∞—Ä—Ç–∞ –ø—Ä–æ–±–ª–µ–º{% endblock %}
{% block extra_css %}
<style>
    /* –°–∫—Ä—ã–≤–∞–µ–º —Ñ–ª–∞–≥ Leaflet –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã */
    .leaflet-attribution-flag {
        display: none !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ */
    .custom-marker {
        position: relative;
        width: 40px;
        height: 52px;
        transition: transform 0.2s;
    }
    
    .custom-marker:hover {
        transform: scale(1.1);
        z-index: 1000 !important;
    }
    
    .marker-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 3px solid var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        position: relative;
        z-index: 2;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .marker-triangle {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 14px solid var(--primary-green);
        position: absolute;
        bottom: 0;
        left: 10px;
        z-index: 1;
    }
    
    .custom-marker-icon {
        background: transparent !important;
        border: none !important;
    }

    /* --- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê --- */
    .problem-modal {
        display: none;
        position: fixed; /* Fixed —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞ */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 750px;
        max-width: 95vw;
        max-height: 90vh;
        z-index: 2000; /* –í—ã—à–µ –∫–∞—Ä—Ç—ã */
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden; /* –ß—Ç–æ–±—ã —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–ª–∏ */
        border: 2px solid var(--primary-green);
    }
    
    /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
        backdrop-filter: blur(2px);
    }
    
    .modal-layout {
        display: flex;
        flex-direction: row;
        height: 100%;
        min-height: 450px;
    }
    
    /* –õ–µ–≤–∞—è —á–∞—Å—Ç—å (–§–æ—Ç–æ) */
    .photo-section {
        flex: 1;
        background-color: var(--bg-beige);
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-right: 1px solid #eee;
    }
    
    .photo-upload-area {
        width: 100%;
        height: 100%;
        min-height: 250px;
        border: 2px dashed #ccc;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
        position: relative;
        overflow: hidden;
    }
    
    .photo-upload-area:hover {
        border-color: var(--primary-green);
        background: #fafafa;
    }
    
    .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    /* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (–§–æ—Ä–º–∞) */
    .form-section {
        flex: 1.4;
        padding: 25px;
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* –°–∫—Ä–æ–ª–ª –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –¥–ª–∏–Ω–Ω–∞—è */
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-title {
        margin: 0;
        color: var(--primary-green);
        font-weight: 800;
        font-size: 1.4rem;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        transition: color 0.2s;
    }
    .close-btn:hover { color: var(--accent-red); }
    
    /* –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã */
    .form-control-custom {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 15px;
        font-family: inherit;
        transition: border-color 0.2s;
    }
    
    .form-control-custom:focus {
        outline: none;
        border-color: var(--primary-green);
    }
    
    /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
    .category-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 20px;
    }
    
    .cat-btn {
        padding: 8px 5px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 700;
        color: #555;
        cursor: pointer;
        transition: all 0.1s;
    }
    
    .cat-btn:hover { background: #f5f5f5; }
    
    .cat-btn.selected {
        background: var(--primary-green);
        color: white;
        border-color: var(--primary-green);
        box-shadow: 0 4px 10px rgba(27, 75, 67, 0.2);
    }
    
    /* –°–ª–æ–∂–Ω–æ—Å—Ç—å */
    .severity-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        align-items: center;
    }
    
    .severity-label { font-weight: 700; color: var(--primary-green); font-size: 0.9rem; }
    
    .sev-circles { display: flex; gap: 10px; }
    
    .sev-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        cursor: pointer;
        opacity: 0.4;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .sev-circle:hover { opacity: 0.7; transform: scale(1.1); }
    .sev-circle.selected { opacity: 1; transform: scale(1.1); box-shadow: 0 0 0 2px #333; }
    
    .bg-min { background: #4CAF50; }
    .bg-green { background: #27AE60; }
    .bg-yellow { background: #F1C40F; }
    .bg-orange { background: #e67e22; }
    .bg-red { background: #E74C3C; }
    .bg-max { background: #DC3522; }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .modal-footer {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .btn-submit {
        background: var(--accent-red);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 800;
        cursor: pointer;
        text-transform: uppercase;
        transition: transform 0.1s;
    }
    .btn-submit:hover { background: #c0392b; }
    .btn-submit:active { transform: scale(0.95); }
    
    .reward-tag {
        font-weight: 800;
        color: var(--primary-green);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 1.1rem;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    @media (max-width: 768px) {
        .modal-layout { flex-direction: column; }
        .photo-section { min-height: 180px; padding: 10px; }
        .problem-modal { width: 95vw; height: auto; max-height: 95vh; }
        .form-section { padding: 15px; }
        .category-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .btn-like.active { color: #27AE60 !important; }
    .btn-dislike.active { color: #E74C3C !important; }
</style>
{% endblock %}

{% block content %}
<!-- –ö–∞—Ä—Ç–∞ -->
<div id="map"></div>

<!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ -->
<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>

<!-- 1. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø -->
<div id="addModal" class="problem-modal">
    <div class="modal-layout">
        <!-- –§–æ—Ç–æ -->
        <div class="photo-section">
            <label class="photo-upload-area" id="uploadArea">
                <input type="file" id="problemPhoto" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                <div id="uploadPlaceholder" style="text-align: center;">
                    <i class="fas fa-camera fa-3x" style="color: #ccc; margin-bottom: 10px;"></i>
                    <div style="font-weight: 700; color: #999;">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                    <div style="font-size: 0.8rem; color: #bbb;">(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
                </div>
                <div id="photoPreview" class="photo-preview" style="display: none;">
                    <img id="previewImg" src="" alt="Preview">
                </div>
            </label>
        </div>
        
        <!-- –§–æ—Ä–º–∞ -->
        <div class="form-section">
            <div class="modal-header">
                <h2 class="modal-title">–ù–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞</h2>
                <button class="close-btn" onclick="closeAllModals()">√ó</button>
            </div>
            
            <input type="text" class="form-control-custom" id="probTitle" placeholder="–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? (–ù–∞–ø—Ä–∏–º–µ—Ä: –ú—É—Å–æ—Ä –≤ –ø–∞—Ä–∫–µ)">
            
            <div style="margin-bottom: 5px; font-weight: 700; color: var(--primary-green); font-size: 0.85rem;">–ö–ê–¢–ï–ì–û–†–ò–Ø</div>
            <div class="category-grid">
                <div class="cat-btn selected" onclick="selectCat('other', this)">‚ö†Ô∏è –î—Ä—É–≥–æ–µ</div>
                <div class="cat-btn" onclick="selectCat('pollution', this)">‚ôªÔ∏è –ú—É—Å–æ—Ä</div>
                <div class="cat-btn" onclick="selectCat('plants', this)">üåø –†–∞—Å—Ç–µ–Ω–∏—è</div>
                <div class="cat-btn" onclick="selectCat('damage', this)">üî® –ü–æ–ª–æ–º–∫–∞</div>
                <div class="cat-btn" onclick="selectCat('water', this)">üíß –í–æ–¥–∞</div>
                <div class="cat-btn" onclick="selectCat('animals', this)">üêæ –ñ–∏–≤–æ—Ç–Ω—ã–µ</div>
            </div>
            
            <div class="severity-row">
                <span class="severity-label">–í–ê–ñ–ù–û–°–¢–¨</span>
                <div class="sev-circles">
                    <div class="sev-circle bg-min" onclick="selectSev(1, this)">1</div>
                    <div class="sev-circle bg-green" onclick="selectSev(2, this)">2</div>
                    <div class="sev-circle bg-yellow selected" onclick="selectSev(3, this)">3</div>
                    <div class="sev-circle bg-orange" onclick="selectSev(4, this)">4</div>
                    <div class="sev-circle bg-red" onclick="selectSev(5, this)">5</div>
                    <div class="sev-circle bg-max" onclick="selectSev(6, this)">6</div>
                </div>
            </div>
            
            <textarea class="form-control-custom" id="probDesc" style="flex: 1; min-height: 80px; resize: vertical;" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></textarea>
            
            <div class="modal-footer">
                <div class="reward-tag">
                    <i class="fas fa-coins" style="color: var(--accent-yellow);"></i> +15
                </div>
                <button class="btn-submit" onclick="submitProblem()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- 2. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–†–û–°–ú–û–¢–†–ê -->
<div id="viewModal" class="problem-modal">
    <div class="modal-layout">
        <div class="photo-section" id="viewPhotoContainer">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Ñ–æ—Ç–æ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É -->
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f5f5f5; border-radius:8px;">
                <i class="fas fa-image fa-4x" style="color:#ddd;"></i>
            </div>
        </div>
        
        <div class="form-section">
            <div class="modal-header">
                <h2 class="modal-title" id="viewTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
                <button class="close-btn" onclick="closeAllModals()">√ó</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <span id="viewCategoryBadge" style="padding: 4px 10px; border-radius: 15px; background: #eee; font-weight: 700; font-size: 0.8rem;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                <span id="viewSeverityBadge" style="padding: 4px 10px; border-radius: 15px; background: #eee; font-weight: 700; font-size: 0.8rem; margin-left: 5px;">–í–∞–∂–Ω–æ—Å—Ç—å</span>
            </div>
            
            <p id="viewDesc" style="color: #555; line-height: 1.6; flex: 1; overflow-y: auto;">
                –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã...
            </p>
            
            <div style="margin: 15px 0; display: flex; gap: 15px; align-items: center;" id="voteSection">
                <button class="btn-like" onclick="voteProblem('like')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #ccc;">
                    <i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span>
                </button>
                <button class="btn-dislike" onclick="voteProblem('dislike')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #ccc;">
                    <i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span>
                </button>
            </div>
            
            <div class="modal-footer">
                <button style="background: white; border: 2px solid var(--primary-green); color: var(--primary-green); padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer;" onclick="showComplaintForm()">
                    –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                </button>
                <button class="btn-submit" style="background: #27AE60;" onclick="completeProblem()">
                    <i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 3. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ñ–ê–õ–û–ë–´ -->
<div id="complaintModal" class="problem-modal" style="width: 400px; height: auto; min-height: auto;">
    <div style="padding: 25px;">
        <div class="modal-header">
            <h3 class="modal-title">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</h3>
            <button class="close-btn" onclick="closeAllModals()">√ó</button>
        </div>
        
        <select class="form-control-custom" id="complaintReason">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É...</option>
            <option value="spam">–°–ø–∞–º / –†–µ–∫–ª–∞–º–∞</option>
            <option value="fake">–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞</option>
            <option value="offensive">–û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
            <option value="duplicate">–î—É–±–ª–∏–∫–∞—Ç</option>
        </select>
        
        <textarea class="form-control-custom" id="complaintText" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏..." style="min-height: 80px;"></textarea>
        
        <button class="btn-submit" style="width: 100%;" onclick="submitComplaint()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
    </div>
</div>

<script>
	const currentUserId = {{ current_user_id|tojson }};

    let map;
    let markers = {};
    let currentLatLng = null; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
    
    // –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã
    let newProblemData = {
        category: 'other',
        severity: 3
    };
    
    let currentViewId = null; // ID –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–π –ø—Ä–æ–±–ª–µ–º—ã
    let currentProblemId = null; // –î–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    let userVote = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    function initMap() {
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ –∏–∑ localStorage (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤ base.html)
        const cityLat = parseFloat(localStorage.getItem('cityLat')) || 53.9925; // –î–µ—Ñ–æ–ª—Ç –ö–∏—Å–µ–ª–µ–≤—Å–∫
        const cityLng = parseFloat(localStorage.getItem('cityLng')) || 86.6669;
        
        map = L.map('map').setView([cityLat, cityLng], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        map.on('click', function(e) {
            currentLatLng = e.latlng;
            openAddModal();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫
        loadProblems();
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å API
    async function loadProblems() {
		try {
			const response = await fetch('/api/problems');
			const problems = await response.json();
			
			console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:', problems.length);
			
			// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
			for (let id in markers) {
				map.removeLayer(markers[id]);
			}
			markers = {};
			
			// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–±–ª–µ–º
			problems.forEach(p => {
				addMarkerToMap(p);
			});
			
			// –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î
			// (–æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–æ–¥–µ—Ä–∞—Ü–∏—é)
			Object.keys(markers).forEach(markerId => {
				if (!problems.find(p => p.id == markerId)) {
					map.removeLayer(markers[markerId]);
					delete markers[markerId];
				}
			});
			
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–±–ª–µ–º:', error);
		}
	}
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É
    function addMarkerToMap(p) {
        const iconMap = {
            'pollution': 'üöØ', 
            'plants': 'üåø', 
            'water': 'üíß', 
            'damage': 'üî®', 
            'animals': 'üêï', 
            'other': '‚ö†Ô∏è'
        };
        
        const emoji = iconMap[p.category] || '‚ö†Ô∏è';
        
        const customIcon = L.divIcon({
            className: 'custom-marker-icon',
            html: `
                <div class="custom-marker">
                    <div class="marker-circle">${emoji}</div>
                    <div class="marker-triangle"></div>
                </div>
            `,
            iconSize: [40, 52],
            iconAnchor: [20, 52]
        });
        
        const marker = L.marker([p.lat, p.lng], {icon: customIcon}).addTo(map);
        
        // –ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø–µ—Ä–µ–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é openViewModal –≤ –∑–∞–º—ã–∫–∞–Ω–∏–µ
        marker.on('click', function() {
            console.log('–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –ø—Ä–æ–±–ª–µ–º—ã:', p.id, p.title);
            openViewModal(p);
        });
        
        markers[p.id] = marker;
    }
    
    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–¨–ù–´–ú–ò –û–ö–ù–ê–ú–ò ---
    
    function openAddModal() {
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        document.getElementById('probTitle').value = '';
        document.getElementById('probDesc').value = '';
        document.getElementById('problemPhoto').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('uploadPlaceholder').style.display = 'block';
        
        newProblemData = { category: 'other', severity: 3 };
        
        // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
        document.querySelector('.cat-btn:first-child').classList.add('selected'); // –í—ã–±–æ—Ä 'other'
        
        document.querySelectorAll('.sev-circle').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.sev-circle')[2].classList.add('selected'); // –í—ã–±–æ—Ä 3
        
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('addModal').style.display = 'block';
    }
    
    function closeAllModals() {
        document.querySelectorAll('.problem-modal').forEach(m => m.style.display = 'none');
        document.getElementById('modalOverlay').style.display = 'none';
    }
    
    // –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    window.selectCat = function(cat, element) {
        newProblemData.category = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
        element.classList.add('selected');
    }
    
    // –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    window.selectSev = function(sev, element) {
        newProblemData.severity = sev;
        document.querySelectorAll('.sev-circle').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
    window.previewPhoto = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('uploadPlaceholder').style.display = 'none';
            }
            reader.readAsDataURL(file);
        }
    }
    
    // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ---
    
    async function submitProblem() {
        const title = document.getElementById('probTitle').value;
        const desc = document.getElementById('probDesc').value;
        const photoInput = document.getElementById('problemPhoto');
        
        if (!title) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã');
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', desc);
        formData.append('lat', currentLatLng.lat);
        formData.append('lng', currentLatLng.lng);
        formData.append('category', newProblemData.category);
        formData.append('severity', newProblemData.severity);
        
        if (photoInput.files[0]) {
            formData.append('photo', photoInput.files[0]);
        }
        
        try {
            const response = await fetch('/api/problems/add', {
                method: 'POST',
                body: formData // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º Content-Type, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç boundary
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                closeAllModals();
                loadProblems(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
                
                // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–≤ —Ä–µ–∞–ª–µ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä)
                const balanceEl = document.getElementById('currency-amount');
                if(balanceEl) balanceEl.innerText = parseInt(balanceEl.innerText) + 15;
                
                alert('–ü—Ä–æ–±–ª–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –í—ã –ø–æ–ª—É—á–∏–ª–∏ +15 –§–ú');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }
    
    // --- –ü–†–û–°–ú–û–¢–† –ò –î–ï–ô–°–¢–í–ò–Ø ---
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏–∑ –∞–¥–º–∏–Ω–∫–∏
	window.refreshMapFromAdmin = function() {
		console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏–∑ –∞–¥–º–∏–Ω–∫–∏...');
		if (typeof loadProblems === 'function') {
			loadProblems();
			return true;
		}
		return false;
	};
	
    window.openViewModal = function(p) {
        console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ–±–ª–µ–º—ã:', p.id);
        
        currentProblemId = p.id;
        currentViewId = p.id;
        
        document.getElementById('viewTitle').innerText = p.title;
        document.getElementById('viewDesc').innerText = p.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
        
        // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
        const catMap = {
            'pollution': '–ú—É—Å–æ—Ä', 
            'plants': '–†–∞—Å—Ç–µ–Ω–∏—è', 
            'damage': '–ü–æ–ª–æ–º–∫–∞', 
            'water': '–í–æ–¥–∞',
            'animals': '–ñ–∏–≤–æ—Ç–Ω—ã–µ',
            'other': '–î—Ä—É–≥–æ–µ'
        };
        document.getElementById('viewCategoryBadge').innerText = catMap[p.category] || p.category;
        
        // –í–∞–∂–Ω–æ—Å—Ç—å
        const severityText = p.severity >= 5 ? '–ö—Ä–∏—Ç–∏—á–Ω–æ' : p.severity >= 3 ? '–°—Ä–µ–¥–Ω–µ' : '–ù–∏–∑–∫–æ';
        document.getElementById('viewSeverityBadge').innerText = `–í–∞–∂–Ω–æ—Å—Ç—å: ${severityText}`;
        
        // –§–æ—Ç–æ
        const photoContainer = document.getElementById('viewPhotoContainer');
        if (p.photo) {
            photoContainer.innerHTML = `<img src="${p.photo}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
        } else {
            photoContainer.innerHTML = `
                <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f5f5f5; border-radius:8px;">
                    <i class="fas fa-image fa-4x" style="color:#ddd;"></i>
                </div>
            `;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫–æ–≤
        document.getElementById('likeCount').textContent = p.likes || 0;
        document.getElementById('dislikeCount').textContent = p.dislikes || 0;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        loadVoteStatus(p.id);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        updateModalFooter(p);
        
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('viewModal').style.display = 'block';
    };
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
    function updateModalFooter(p) {
        const footer = document.querySelector('#viewModal .modal-footer');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
        if (p.status === 'completed') {
            // –ó–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
            footer.innerHTML = `
                <div style="color: #27AE60; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i> –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
                </div>
            `;
        } else if (p.assigned_to) {
            // –ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–º—É-—Ç–æ
            if (p.assigned_to === currentUserId) {
                // –ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                footer.innerHTML = `
                    <button style="background: white; border: 2px solid var(--primary-green); color: var(--primary-green); padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer; margin-right: 10px;" onclick="openReportModalFromMap(${p.id})">
                        <i class="fas fa-camera"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å —Ñ–æ—Ç–æ
                    </button>
                    <button style="background: white; border: 2px solid #999; color: #999; padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer;" onclick="unassignProblemFromMap(${p.id})">
                        <i class="fas fa-times"></i> –û—Ç–∫–∞–∑–∞—Ç—å—Å—è
                    </button>
                `;
            } else {
                // –ó–∞–¥–∞—á–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                footer.innerHTML = `
                    <div style="color: #999; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-clock"></i> –ó–∞–¥–∞—á–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                    </div>
                `;
            }
        } else {
            // –ó–∞–¥–∞—á–∞ —Å–≤–æ–±–æ–¥–Ω–∞
            if (p.user_id === currentUserId) {
                // –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                footer.innerHTML = `
                    <div style="color: var(--primary-green); font-weight: 700; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-info-circle"></i> –í—ã —Å–æ–∑–¥–∞–ª–∏ —ç—Ç—É –∑–∞–¥–∞—á—É
                    </div>
                `;
            } else {
                // –ó–∞–¥–∞—á–∞ —Å–≤–æ–±–æ–¥–Ω–∞ –¥–ª—è –≤–∑—è—Ç–∏—è
                footer.innerHTML = `
                    <button style="background: white; border: 2px solid var(--primary-green); color: var(--primary-green); padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer; margin-right: 10px;" onclick="assignProblemFromMap(${p.id})">
                        <i class="fas fa-hand-paper"></i> –í–∑—è—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                    <button style="background: white; border: 2px solid #ddd; color: #666; padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer;" onclick="showComplaintForm()">
                        <i class="fas fa-flag"></i> –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è
                    </button>
                `;
            }
        }
    }
    
    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–∞ —Å –∫–∞—Ä—Ç—ã
    async function openReportModalFromMap(problemId) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ —É–∂–µ –∑–∞–¥–∞—á–∞
        try {
            const response = await fetch(`/api/problems/${problemId}/status`);
            const data = await response.json();
            
            if (data.status === 'completed') {
                alert('–≠—Ç–∞ –∑–∞–¥–∞—á–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!');
                closeAllModals();
                loadProblems();
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeAllModals();
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–∞
            createReportModal(problemId);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            closeAllModals();
            createReportModal(problemId);
        }
    }
    
    // –°–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–∞
    function createReportModal(problemId) {
        // –°–æ–∑–¥–∞–µ–º overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.style.display = 'block';
        overlay.onclick = () => {
            document.body.removeChild(overlay);
            document.body.removeChild(modal);
        };
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.className = 'problem-modal';
        modal.style.width = '600px';
        modal.style.height = 'auto';
        
        modal.innerHTML = `
            <div style="padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--primary-green);">–§–æ—Ç–æ–æ—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏</h3>
                    <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement); document.body.removeChild(document.querySelector('.modal-overlay:last-child'))" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">√ó</button>
                </div>
                
                <input type="hidden" id="mapTaskId" value="${problemId}">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div>
                        <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;" onclick="document.getElementById('mapBeforePhoto').click()">
                            <input type="file" id="mapBeforePhoto" accept="image/*" style="display: none;" onchange="previewMapPhoto('before', this)">
                            <i class="fas fa-camera fa-2x" style="color: #ccc; margin-bottom: 10px;"></i>
                            <div style="font-weight: 700; color: #999;">–§–æ—Ç–æ "–ë—ã–ª–æ"</div>
                            <div style="font-size: 0.8rem; color: #bbb;">(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
                            <img id="mapBeforePreview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none;" src="" alt="Preview">
                        </div>
                    </div>
                    
                    <div>
                        <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;" onclick="document.getElementById('mapAfterPhoto').click()">
                            <input type="file" id="mapAfterPhoto" accept="image/*" style="display: none;" onchange="previewMapPhoto('after', this)">
                            <i class="fas fa-camera fa-2x" style="color: #ccc; margin-bottom: 10px;"></i>
                            <div style="font-weight: 700; color: #999;">–§–æ—Ç–æ "–°—Ç–∞–ª–æ"</div>
                            <div style="font-size: 0.8rem; color: #bbb;">(–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                            <img id="mapAfterPreview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none;" src="" alt="Preview">
                        </div>
                    </div>
                </div>
                
                <textarea id="mapReportDescription" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É..." 
                          style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin: 15px 0; min-height: 100px;"></textarea>
                
                <button onclick="submitMapReport()" style="width: 100%; background: var(--primary-green); color: white; border: none; padding: 14px; border-radius: 25px; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-check"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–ª—ã
                </button>
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å –∫–∞—Ä—Ç—ã
    function previewMapPhoto(type, input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(`map${type.charAt(0).toUpperCase() + type.slice(1)}Preview`);
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç —Å –∫–∞—Ä—Ç—ã
    async function submitMapReport() {
        const problemId = document.getElementById('mapTaskId').value;
        const beforePhoto = document.getElementById('mapBeforePhoto').files[0];
        const afterPhoto = document.getElementById('mapAfterPhoto').files[0];
        const description = document.getElementById('mapReportDescription').value;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ "–ø–æ—Å–ª–µ"
        if (!afterPhoto) {
            alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ "–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"');
            return;
        }
        
        const formData = new FormData();
        formData.append('description', description);
        if (beforePhoto) formData.append('before_photo', beforePhoto);
        formData.append('after_photo', afterPhoto);
        
        try {
            const response = await fetch(`/api/problems/${problemId}/complete_with_report`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.querySelectorAll('.modal-overlay').forEach(el => el.remove());
                document.querySelectorAll('.problem-modal').forEach(el => el.remove());
                
                alert(`–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –ù–∞—á–∏—Å–ª–µ–Ω–æ +${result.reward} –±–∞–ª–ª–æ–≤`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ —à–∞–ø–∫–µ
                const balanceEl = document.getElementById('currency-amount');
                if(balanceEl && result.new_balance) {
                    balanceEl.innerText = result.new_balance;
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
                loadProblems();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    }
    
    // –í–∑—è—Ç—å –∑–∞–¥–∞—á—É —Å –∫–∞—Ä—Ç—ã
    async function assignProblemFromMap(problemId) {
        if(!confirm('–í–∑—è—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É –≤ —Ä–∞–±–æ—Ç—É?\n–ü–æ—Å–ª–µ –≤–∑—è—Ç–∏—è –æ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –∑–∞ –≤–∞–º–∏.')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/assign`, { method: 'POST' });
            const result = await response.json();
            
            if (result.status === 'success') {
                alert('–ó–∞–¥–∞—á–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ –∑–∞ –≤–∞–º–∏! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –µ–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å.');
                closeAllModals();
                loadProblems(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    }
    
    // –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∑–∞–¥–∞—á–∏ —Å –∫–∞—Ä—Ç—ã
    async function unassignProblemFromMap(problemId) {
        if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏?')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/unassign`, { method: 'POST' });
            const result = await response.json();
            
            if (result.status === 'success') {
                alert('–ó–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                closeAllModals();
                loadProblems(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
    }
    
    // –ë—ã—Å—Ç—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å –∫–∞—Ä—Ç—ã (–±–µ–∑ —Ñ–æ—Ç–æ)
    async function completeSimpleFromMap(problemId) {
        if(!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É –±–µ–∑ —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–∞? (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/complete_simple`, { method: 'POST' });
            const result = await response.json();
            
            if (result.status === 'success') {
                closeAllModals();
                loadProblems();
                
                const balanceEl = document.getElementById('currency-amount');
                if(balanceEl && result.new_balance) {
                    balanceEl.innerText = result.new_balance;
                }
                
                alert(`–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –ù–∞—á–∏—Å–ª–µ–Ω–æ +${result.reward} –§–ú`);
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞');
            }
        } catch (e) { 
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
        }
    }
    
    async function loadVoteStatus(problemId) {
        try {
            const response = await fetch(`/api/problems/${problemId}/vote_status`);
            const data = await response.json();
            
            userVote = data.user_vote;
            updateVoteButtons();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            document.getElementById('likeCount').textContent = data.likes || 0;
            document.getElementById('dislikeCount').textContent = data.dislikes || 0;
            
        } catch (e) {
            console.error('Error loading vote status:', e);
        }
    }
    
    function updateVoteButtons() {
        const likeBtn = document.querySelector('.btn-like');
        const dislikeBtn = document.querySelector('.btn-dislike');
        
        likeBtn.classList.remove('active');
        dislikeBtn.classList.remove('active');
        
        if (userVote === 'like') {
            likeBtn.classList.add('active');
        } else if (userVote === 'dislike') {
            dislikeBtn.classList.add('active');
        }
    }
    
    window.completeProblem = async function() {
        if (!currentViewId) return;
        
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;
        
        try {
            const res = await fetch(`/api/problems/${currentViewId}/complete`, { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'success') {
                closeAllModals();
                loadProblems();
                
                const balanceEl = document.getElementById('currency-amount');
                if(balanceEl) balanceEl.innerText = parseInt(balanceEl.innerText) + data.reward;
                
                alert(`–û—Ç–ª–∏—á–Ω–æ! –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ù–∞—á–∏—Å–ª–µ–Ω–æ +${data.reward} –§–ú`);
            }
        } catch (e) { 
            console.error(e);
            alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
        }
    };
    
    window.showComplaintForm = function() {
        document.getElementById('viewModal').style.display = 'none';
        document.getElementById('complaintModal').style.display = 'block';
    };
    
    window.submitComplaint = async function() {
        const reason = document.getElementById('complaintReason').value;
        const text = document.getElementById('complaintText').value;
        
        if(!reason) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É');
            return;
        }
        
        if (!currentViewId) {
            alert('–û—à–∏–±–∫–∞: –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
            return;
        }
        
        try {
            const response = await fetch('/api/complaints/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    problem_id: currentViewId,
                    reason: reason,
                    description: text
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                closeAllModals();
                alert('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º.');
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã');
            }
        } catch(e) { 
            console.error(e);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    };
    
    window.voteProblem = async function(type) {
        if (!currentProblemId) return;
        
        try {
            const response = await fetch(`/api/problems/${currentProblemId}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type: type })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('likeCount').textContent = data.likes;
                document.getElementById('dislikeCount').textContent = data.dislikes;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                if (userVote === type) {
                    userVote = null; // –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞
                } else {
                    userVote = type; // –ù–æ–≤—ã–π –≥–æ–ª–æ—Å
                }
                updateVoteButtons();
            }
        } catch (e) {
            console.error('Error voting:', e);
            alert('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
        }
    };

    // –ó–∞–ø—É—Å–∫ –∫–∞—Ä—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
