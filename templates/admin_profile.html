{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π{% endblock %}
{% block extra_css %}
<style>
    /* –ï–¥–∏–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ */
    :root {
        --primary-green: #1B4B43;
        --bg-beige: #F2EFE4;
        --accent-red: #E74C3C;
        --accent-yellow: #F1C40F;
        --accent-blue: #2980b9;
        --accent-green: #27AE60;
        --border-thick: 2px solid #1B4B43;
        --radius-main: 12px;
    }

    .admin-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        padding-bottom: 40px;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    
    .admin-stat-card {
        background: white;
        border-radius: var(--radius-main);
        padding: 25px;
        border: var(--border-thick);
        text-align: center;
        box-shadow: 0 4px 0 rgba(27, 75, 67, 0.1);
        transition: transform 0.2s;
    }
    
    .admin-stat-card:hover {
        transform: translateY(-3px);
    }
    
    .admin-stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary-green);
        margin: 10px 0;
        line-height: 1;
    }
    
    .admin-stat-label {
        color: #666;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* –°–µ–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .admin-section {
        background: white;
        border-radius: var(--radius-main);
        padding: 0;
        border: var(--border-thick);
        overflow: hidden; /* –ß—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∞ */
    }
    
    .section-header {
        background-color: var(--bg-beige);
        padding: 20px 25px;
        border-bottom: 2px solid var(--primary-green);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .section-title {
        color: var(--primary-green);
        font-size: 1.2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
        text-transform: uppercase;
    }
    
    /* –¢–∞–±–ª–∏—Ü—ã */
    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .admin-table th {
        background: #fafafa;
        color: var(--primary-green);
        padding: 15px 20px;
        text-align: left;
        font-weight: 700;
        border-bottom: 1px solid #ddd;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    .admin-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        color: #333;
        vertical-align: middle;
    }
    
    .admin-table tr:last-child td {
        border-bottom: none;
    }
    
    .admin-table tr:hover {
        background: #f9f9f9;
    }
    
    /* –°—Ç–∞—Ç—É—Å—ã */
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .status-pending { background: #FFF3E0; color: #E67E22; border: 1px solid #FFE0B2; }
    .status-reviewed { background: #E3F2FD; color: #2980b9; border: 1px solid #BBDEFB; }
    .status-resolved { background: #E8F5E9; color: #27AE60; border: 1px solid #C8E6C9; }
    .status-rejected { background: #FFEBEE; color: #E74C3C; border: 1px solid #FFCDD2; }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.75rem;
        transition: transform 0.1s, opacity 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        text-transform: uppercase;
    }
    
    .btn-action:hover { opacity: 0.9; }
    .btn-action:active { transform: scale(0.95); }
    
    .btn-approve { background: var(--accent-green); color: white; }
    .btn-reject { background: var(--accent-red); color: white; }
    .btn-view { background: var(--accent-blue); color: white; }
    .btn-delete { background: #dc3545; color: white; }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ */
    .severity-indicator {
        width: 10px; height: 10px; border-radius: 50%;
        display: inline-block; margin-right: 8px;
    }
    .severity-low { background: var(--accent-green); }
    .severity-mid { background: var(--accent-yellow); }
    .severity-high { background: var(--accent-red); }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #999;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #ddd;
    }
    
    /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .quick-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: transform 0.2s;
    }
    
    .quick-btn:hover {
        transform: translateY(-2px);
        text-decoration: none;
    }
    
    .btn-moderation { background: var(--accent-red); color: white; }
    .btn-analytics { background: var(--primary-green); color: white; }
    .btn-users { background: var(--accent-blue); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="quick-actions">
        <a href="{{ url_for('admin_panel') }}#moderation" class="quick-btn btn-moderation">
            <i class="fas fa-gavel"></i> –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∂–∞–ª–æ–±
            {% if complaints %}
            <span class="badge bg-light text-danger" style="margin-left: 5px;">{{ complaints|length }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('analytics') }}" class="quick-btn btn-analytics">
            <i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        </a>
        <a href="{{ url_for('admin_panel') }}#users" class="quick-btn btn-users">
            <i class="fas fa-users"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        </a>
    </div>
    
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> –û–±–∑–æ—Ä –¥–∞–Ω–Ω—ã—Ö</h2>
            <span class="badge bg-primary">–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ now.strftime('%H:%M') }}</span>
        </div>
        <div style="padding: 20px;">
            <div class="admin-stats-grid">
                <div class="admin-stat-card">
                    <div class="admin-stat-value">{{ users|length }}</div>
                    <div class="admin-stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">{{ problems|length }}</div>
                    <div class="admin-stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" style="color: var(--accent-red);">{{ complaints|length }}</div>
                    <div class="admin-stat-label">–ñ–∞–ª–æ–± –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" style="color: var(--accent-green);">
                        {{ problems|selectattr('status', 'equalto', 'completed')|list|length }}
                    </div>
                    <div class="admin-stat-label">–†–µ—à–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ñ–ê–õ–û–ë–´ (MODERATION) -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-gavel"></i> –ñ–∞–ª–æ–±—ã –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
                {% if complaints %}
                <span style="background:var(--accent-red); color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">{{ complaints|length }} –Ω–æ–≤—ã—Ö</span>
                {% endif %}
            </h2>
            <button class="btn btn-sm btn-primary" onclick="loadAllComplaints()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        
        {% if complaints %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                    <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                    <th>–ó–∞—è–≤–∏—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="complaintsTable">
                {% for complaint in complaints %}
                <tr id="complaint-row-{{ complaint.id }}">
                    <td>#{{ complaint.id }}</td>
                    <td>
                        <span style="font-weight:700; color:var(--accent-red);">
                            {% if complaint.reason == 'spam' %}
                                –°–ø–∞–º/–†–µ–∫–ª–∞–º–∞
                            {% elif complaint.reason == 'fake' %}
                                –§–µ–π–∫–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞
                            {% elif complaint.reason == 'offensive' %}
                                –û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                            {% elif complaint.reason == 'duplicate' %}
                                –î—É–±–ª–∏–∫–∞—Ç
                            {% else %}
                                {{ complaint.reason }}
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if complaint.problem %}
                            <div style="font-weight:600;">{{ complaint.problem.title[:30] }}...</div>
                            <div style="font-size:0.8rem; color:#888;">ID: {{ complaint.problem.id }}</div>
                        {% else %}
                            <span style="color:#999; font-style:italic;">–ö–æ–Ω—Ç–µ–Ω—Ç —É–¥–∞–ª–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ complaint.user.username }}</td>
                    <td>{{ complaint.created_at.strftime('%d.%m.%Y') }}</td>
                    <td class="action-buttons">
                        {% if complaint.problem %}
                        <button class="btn-action btn-approve" onclick="resolveComplaint({{ complaint.id }}, 'delete_problem')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                        {% endif %}
                        <button class="btn-action btn-reject" onclick="rejectComplaint({{ complaint.id }})">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                        <button class="btn-action btn-view" onclick="viewComplaintDetails({{ complaint.id }})">
                            <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∂–∞–ª–æ–±</h3>
            <p>–í—Å–µ –∂–∞–ª–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã</p>
        </div>
        {% endif %}
        
        <div style="padding: 15px 25px; border-top: 1px solid #eee; background: #fafafa;">
            <a href="{{ url_for('admin_panel') }}#moderation" class="btn btn-sm btn-danger">
                <i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–æ–ª–Ω—ã–π —Ä–µ–∂–∏–º –º–æ–¥–µ—Ä–∞—Ü–∏–∏
            </a>
        </div>
    </div>
    
    <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–ê–ú–ò -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã</h2>
            <button class="btn btn-sm btn-success" onclick="createProblem()">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
            </button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ù–∞–≥—Ä–∞–¥–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for problem in problems if problem.status != 'completed' %}
                    <tr id="problem-row-{{ problem.id }}">
                        <td>#{{ problem.id }}</td>
                        <td>
                            <div style="font-weight:700;">{{ problem.title[:40] }}...</div>
                            {% if problem.category %}
                            <div style="font-size:0.75rem; color:#888; text-transform:uppercase;">
                                {% if problem.category == 'pollution' %}
                                    –ú—É—Å–æ—Ä
                                {% elif problem.category == 'plants' %}
                                    –†–∞—Å—Ç–µ–Ω–∏—è
                                {% elif problem.category == 'water' %}
                                    –í–æ–¥–∞
                                {% elif problem.category == 'damage' %}
                                    –ü–æ–ª–æ–º–∫–∞
                                {% elif problem.category == 'animals' %}
                                    –ñ–∏–≤–æ—Ç–Ω—ã–µ
                                {% else %}
                                    {{ problem.category }}
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if problem.severity >= 5 %}
                                <span class="severity-indicator severity-high"></span>–í—ã—Å–æ–∫–∞—è
                            {% elif problem.severity >= 3 %}
                                <span class="severity-indicator severity-mid"></span>–°—Ä–µ–¥–Ω—è—è
                            {% else %}
                                <span class="severity-indicator severity-low"></span>–ù–∏–∑–∫–∞—è
                            {% endif %}
                        </td>
                        <td>
                            {% if problem.status == 'reported' %}
                                <span class="status-badge status-pending">–ù–æ–≤–∞—è</span>
                            {% elif problem.status == 'in_progress' or problem.status == 'assigned' %}
                                <span class="status-badge status-reviewed">–í —Ä–∞–±–æ—Ç–µ</span>
                            {% else %}
                                <span class="status-badge status-resolved">–ì–æ—Ç–æ–≤–æ</span>
                            {% endif %}
                        </td>
                        <td><b style="color: var(--accent-yellow);">{{ problem.reward }} üü°</b></td>
                        <td class="action-buttons">
                            {% if problem.status != 'completed' %}
                            <button class="btn-action btn-approve" onclick="completeProblem({{ problem.id }})">
                                <i class="fas fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                            {% endif %}
                            <button class="btn-action btn-delete" onclick="deleteProblem({{ problem.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (—Ç–æ–ø-10)</h2>
            <a href="{{ url_for('admin_panel') }}#users" class="btn btn-sm btn-primary">
                <i class="fas fa-external-link-alt"></i> –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </a>
        </div>
        
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–†–æ–ª—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users[:10] %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>
                        <div style="font-weight:700;">{{ user.username }}</div>
                        <div style="font-size:0.8rem; color:#888;">{{ user.email }}</div>
                    </td>
                    <td>{{ user.points }} üü°</td>
                    <td>
                        <i class="fas fa-flag" style="color:#ccc;"></i> {{ user.total_reports }}
                        <i class="fas fa-check" style="color:#ccc; margin-left:5px;"></i> {{ user.total_completed }}
                    </td>
                    <td>
                        {% if user.is_admin %}
                            <span class="status-badge" style="background:var(--accent-red); color:white; border:none;">–ê–¥–º–∏–Ω</span>
                        {% elif user.is_worker %}
                            <span class="status-badge" style="background:var(--accent-yellow); color:black; border:none;">–†–∞–±–æ—Ç–Ω–∏–∫</span>
                        {% else %}
                            <span class="status-badge" style="background:#eee; color:#666; border:none;">–Æ–∑–µ—Ä</span>
                        {% endif %}
                    </td>
                    <td class="action-buttons">
                        {% if not user.is_admin %}
                        <button class="btn-action btn-view" onclick="toggleUserRole({{ user.id }})">
                            <i class="fas fa-user-shield"></i> –ü—Ä–∞–≤–∞
                        </button>
                        {% endif %}
                        <button class="btn-action btn-delete" onclick="deleteUserProfile({{ user.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // ==========================================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ñ–ê–õ–û–ë–ê–ú–ò
    // ==========================================
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∂–∞–ª–æ–± —á–µ—Ä–µ–∑ API
    async function loadAllComplaints() {
        try {
            const response = await fetch('/api/complaints/all');
            const complaints = await response.json();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            updateComplaintsTable(complaints.filter(c => c.status === 'pending'));
            
            showNotification('success', '–£—Å–ø–µ—Ö', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${complaints.length} –∂–∞–ª–æ–±`);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±:', error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂–∞–ª–æ–±—ã');
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∂–∞–ª–æ–±
    function updateComplaintsTable(complaints) {
        const tbody = document.getElementById('complaintsTable');
        
        if (complaints.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>–ù–µ—Ç –∂–∞–ª–æ–± –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        
        complaints.forEach(complaint => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–∏—á–∏–Ω—ã
            let reasonText = complaint.reason;
            if (complaint.reason === 'spam') reasonText = '–°–ø–∞–º/–†–µ–∫–ª–∞–º–∞';
            else if (complaint.reason === 'fake') reasonText = '–§–µ–π–∫–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
            else if (complaint.reason === 'offensive') reasonText = '–û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç';
            else if (complaint.reason === 'duplicate') reasonText = '–î—É–±–ª–∏–∫–∞—Ç';
            
            html += `
                <tr id="complaint-row-${complaint.id}">
                    <td>#${complaint.id}</td>
                    <td>
                        <span style="font-weight:700; color:var(--accent-red);">${reasonText}</span>
                    </td>
                    <td>
                        <div style="font-weight:600;">${complaint.problem_title.substring(0, 30)}...</div>
                        <div style="font-size:0.8rem; color:#888;">ID: ${complaint.problem_id}</div>
                    </td>
                    <td>${complaint.user}</td>
                    <td>${complaint.created_at}</td>
                    <td class="action-buttons">
                        <button class="btn-action btn-approve" onclick="resolveComplaint(${complaint.id}, 'delete_problem')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                        <button class="btn-action btn-reject" onclick="rejectComplaint(${complaint.id})">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                        <button class="btn-action btn-view" onclick="viewComplaintDetails(${complaint.id})">
                            <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∞–ª–æ–±—ã
    async function resolveComplaint(complaintId, action) {
		if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?')) return;
		
		try {
			const response = await fetch(`/api/complaints/${complaintId}/resolve`, {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({ 
					action: 'delete_problem', 
					admin_comment: '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è' 
				})
			});
			
			const result = await response.json();
			
			if (result.status === 'success') {
				// –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
				const row = document.getElementById(`complaint-row-${complaintId}`);
				if (row) {
					row.style.opacity = '0.5';
					setTimeout(() => row.remove(), 500);
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∞–ª–æ–±
				setTimeout(() => {
					const badge = document.querySelector('.quick-btn.btn-moderation .badge');
					if (badge) {
						const current = parseInt(badge.textContent) || 0;
						badge.textContent = Math.max(0, current - 1);
					}
				}, 600);
				
				showNotification('success', '–£—Å–ø–µ—Ö', '–ñ–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –ø—Ä–æ–±–ª–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞');
			} else {
				showNotification('error', '–û—à–∏–±–∫–∞', result.message);
			}
		} catch (error) {
			console.error(error);
			showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∂–∞–ª–æ–±—ã');
		}
	}
    
    // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∂–∞–ª–æ–±—ã
    async function rejectComplaint(complaintId) {
        if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∂–∞–ª–æ–±—É –∫–∞–∫ –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é?')) return;
        
        try {
            const response = await fetch(`/api/complaints/${complaintId}/reject`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const row = document.getElementById(`complaint-row-${complaintId}`);
                if (row) row.remove();
                
                showNotification('success', '–£—Å–ø–µ—Ö', '–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', result.message);
            }
        } catch (error) {
            console.error(error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∂–∞–ª–æ–±—ã');
        }
    }
    
    // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –∂–∞–ª–æ–±—ã
    async function viewComplaintDetails(complaintId) {
		try {
			const response = await fetch('/api/complaints/all');
			const complaints = await response.json();
			const complaint = complaints.find(c => c.id === complaintId);
			
			if (!complaint) {
				showNotification('error', '–û—à–∏–±–∫–∞', '–ñ–∞–ª–æ–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
				return;
			}
			
			// –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ HTML —Ç–µ–≥–æ–≤
			let details = `ID –∂–∞–ª–æ–±—ã: #${complaint.id}\n`;
			details += `–ü—Ä–æ–±–ª–µ–º–∞: ${complaint.problem_title}\n`;
			details += `ID –ø—Ä–æ–±–ª–µ–º—ã: ${complaint.problem_id}\n`;
			details += `–°—Ç–∞—Ç—É—Å –ø—Ä–æ–±–ª–µ–º—ã: ${complaint.problem_status}\n`;
			details += `–ü—Ä–∏—á–∏–Ω–∞: ${complaint.reason_text}\n`;
			details += `–û–ø–∏—Å–∞–Ω–∏–µ: ${complaint.description || '‚Äî'}\n`;
			details += `–ñ–∞–ª–æ–±—â–∏–∫: ${complaint.user}\n`;
			details += `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${complaint.created_at}\n`;
			details += `–°—Ç–∞—Ç—É—Å –∂–∞–ª–æ–±—ã: ${complaint.status_text}\n`;
			
			if (complaint.resolved_at) {
				details += `\n–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${complaint.resolved_at}\n`;
				details += `–û–±—Ä–∞–±–æ—Ç–∞–ª: ${complaint.resolved_by || '–°–∏—Å—Ç–µ–º–∞'}\n`;
				if (complaint.admin_comment) {
					details += `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${complaint.admin_comment}\n`;
				}
			}
			
			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
			const modalId = 'detailsModal-' + complaintId;
			let modal = document.getElementById(modalId);
			if (modal) modal.remove();
			
			modal = document.createElement('div');
			modal.id = modalId;
			modal.className = 'modal fade';
			modal.innerHTML = `
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –∂–∞–ª–æ–±—ã #${complaint.id}</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<pre style="white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 5px;">${details}</pre>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
						</div>
					</div>
				</div>
			`;
			
			document.body.appendChild(modal);
			const bsModal = new bootstrap.Modal(modal);
			bsModal.show();
		} catch (error) {
			console.error(error);
			showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∂–∞–ª–æ–±—ã');
		}
	}
    
    // ==========================================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–ë–õ–ï–ú–ê–ú–ò
    // ==========================================
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    async function completeProblem(problemId) {
        if (!confirm('–ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω—É—é?')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/complete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', data.message);
            }
        } catch (error) {
            console.error(error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã');
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    async function deleteProblem(problemId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/delete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', '–ü—Ä–æ–±–ª–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞');
                // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const row = document.getElementById(`problem-row-${problemId}`);
                if (row) row.remove();
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', data.message);
            }
        } catch (error) {
            console.error(error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã');
        }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    function createProblem() {
        const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:');
        const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:');
        const reward = prompt('–ù–∞–≥—Ä–∞–¥–∞ (–±–∞–ª–ª—ã):', '15');
        
        if (title && description && reward) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const cityLat = localStorage.getItem('cityLat') || 53.9925;
            const cityLng = localStorage.getItem('cityLng') || 86.6669;
            
            fetch('/api/problems/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    description: description,
                    lat: parseFloat(cityLat),
                    lng: parseFloat(cityLng),
                    category: 'other',
                    severity: 3,
                    reward: parseInt(reward)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('success', '–£—Å–ø–µ—Ö', '–ü—Ä–æ–±–ª–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∞');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('error', '–û—à–∏–±–∫–∞', data.message);
                }
            })
            .catch(error => {
                console.error(error);
                showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã');
            });
        }
    }
    
    // ==========================================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò
    // ==========================================
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function toggleUserRole(userId) {
        if (!confirm('–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        
        try {
            const response = await fetch(`/api/user/${userId}/toggle_admin`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', `–ü—Ä–∞–≤–∞ ${data.is_admin ? '–≤—ã–¥–∞–Ω—ã' : '—Å–Ω—è—Ç—ã'}`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', data.message);
            }
        } catch (error) {
            console.error(error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤');
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteUserProfile(userId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ?')) return;
        
        try {
            const response = await fetch(`/api/user/${userId}/delete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const row = document.querySelector(`tr:has(td:first-child:contains("${userId}"))`);
                if (row) row.remove();
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', data.message);
            }
        } catch (error) {
            console.error(error);
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
    }
    
    // ==========================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================================
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    setInterval(() => {
        loadAllComplaints();
    }, 300000); // 5 –º–∏–Ω—É—Ç
</script>
{% endblock %}
