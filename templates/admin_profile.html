{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π{% endblock %}
{% block extra_css %}
<style>
    /* –ï–¥–∏–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ */
    :root {
        --primary-green: #1B4B43;
        --bg-beige: #F2EFE4;
        --accent-red: #E74C3C;
        --accent-yellow: #F1C40F;
        --accent-blue: #2980b9;
        --accent-green: #27AE60;
        --border-thick: 2px solid #1B4B43;
        --radius-main: 12px;
    }

    .admin-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        padding-bottom: 40px;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }
    
    .admin-stat-card {
        background: white;
        border-radius: var(--radius-main);
        padding: 25px;
        border: var(--border-thick);
        text-align: center;
        box-shadow: 0 4px 0 rgba(27, 75, 67, 0.1);
        transition: transform 0.2s;
    }
    
    .admin-stat-card:hover {
        transform: translateY(-3px);
    }
    
    .admin-stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary-green);
        margin: 10px 0;
        line-height: 1;
    }
    
    .admin-stat-label {
        color: #666;
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* –°–µ–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .admin-section {
        background: white;
        border-radius: var(--radius-main);
        padding: 0;
        border: var(--border-thick);
        overflow: hidden; /* –ß—Ç–æ–±—ã —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∞ */
    }
    
    .section-header {
        background-color: var(--bg-beige);
        padding: 20px 25px;
        border-bottom: 2px solid var(--primary-green);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .section-title {
        color: var(--primary-green);
        font-size: 1.2rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
        text-transform: uppercase;
    }
    
    /* –¢–∞–±–ª–∏—Ü—ã */
    .admin-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .admin-table th {
        background: #fafafa;
        color: var(--primary-green);
        padding: 15px 20px;
        text-align: left;
        font-weight: 700;
        border-bottom: 1px solid #ddd;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    .admin-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        color: #333;
        vertical-align: middle;
    }
    
    .admin-table tr:last-child td {
        border-bottom: none;
    }
    
    .admin-table tr:hover {
        background: #f9f9f9;
    }
    
    /* –°—Ç–∞—Ç—É—Å—ã */
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .status-pending { background: #FFF3E0; color: #E67E22; border: 1px solid #FFE0B2; }
    .status-reviewed { background: #E3F2FD; color: #2980b9; border: 1px solid #BBDEFB; }
    .status-resolved { background: #E8F5E9; color: #27AE60; border: 1px solid #C8E6C9; }
    
    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        font-size: 0.75rem;
        transition: transform 0.1s, opacity 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        text-transform: uppercase;
    }
    
    .btn-action:hover { opacity: 0.9; }
    .btn-action:active { transform: scale(0.95); }
    
    .btn-approve { background: var(--accent-green); color: white; }
    .btn-reject { background: var(--accent-red); color: white; }
    .btn-view { background: var(--accent-blue); color: white; }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ */
    .severity-indicator {
        width: 10px; height: 10px; border-radius: 50%;
        display: inline-block; margin-right: 8px;
    }
    .severity-low { background: var(--accent-green); }
    .severity-mid { background: var(--accent-yellow); }
    .severity-high { background: var(--accent-red); }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #999;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> –û–±–∑–æ—Ä –¥–∞–Ω–Ω—ã—Ö</h2>
        </div>
        <div style="padding: 20px;">
            <div class="admin-stats-grid">
                <div class="admin-stat-card">
                    <div class="admin-stat-value">{{ users|length }}</div>
                    <div class="admin-stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value">{{ problems|length }}</div>
                    <div class="admin-stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" style="color: var(--accent-red);">{{ complaints|length }}</div>
                    <div class="admin-stat-label">–ñ–∞–ª–æ–± –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                </div>
                <div class="admin-stat-card">
                    <div class="admin-stat-value" style="color: var(--accent-green);">
                        {{ problems|selectattr('status', 'equalto', 'completed')|list|length }}
                    </div>
                    <div class="admin-stat-label">–†–µ—à–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ñ–ê–õ–û–ë–´ (MODERATION) -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-gavel"></i> –ñ–∞–ª–æ–±—ã –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
                {% if complaints %}
                <span style="background:var(--accent-red); color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">{{ complaints|length }}</span>
                {% endif %}
            </h2>
        </div>
        
        {% if complaints %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                    <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                    <th>–ó–∞—è–≤–∏—Ç–µ–ª—å</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for complaint in complaints %}
                <tr id="complaint-row-{{ complaint.id }}">
                    <td>#{{ complaint.id }}</td>
                    <td><span style="font-weight:700; color:var(--accent-red);">{{ complaint.reason }}</span></td>
                    <td>
                        {% if complaint.problem %}
                            <div style="font-weight:600;">{{ complaint.problem.title[:30] }}...</div>
                            <div style="font-size:0.8rem; color:#888;">ID: {{ complaint.problem.id }}</div>
                        {% else %}
                            <span style="color:#999; font-style:italic;">–ö–æ–Ω—Ç–µ–Ω—Ç —É–¥–∞–ª–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ complaint.user.username }}</td>
                    <td>{{ complaint.created_at.strftime('%d.%m.%Y') }}</td>
                    <td class="action-buttons">
                        {% if complaint.problem %}
                        <button class="btn-action btn-approve" onclick="resolveComplaint({{ complaint.id }}, 'delete_content')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç
                        </button>
                        {% endif %}
                        <button class="btn-action btn-reject" onclick="resolveComplaint({{ complaint.id }}, 'reject_complaint')">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>–ß–∏—Å—Ç–æ</h3>
            <p>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∂–∞–ª–æ–± –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è</p>
        </div>
        {% endif %}
    </div>
    
    <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–ê–ú–ò -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-map-marker-alt"></i> –ë–∞–∑–∞ –ø—Ä–æ–±–ª–µ–º</h2>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ù–∞–≥—Ä–∞–¥–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for problem in problems %}
                    <tr id="problem-row-{{ problem.id }}">
                        <td>#{{ problem.id }}</td>
                        <td>
                            <div style="font-weight:700;">{{ problem.title[:40] }}...</div>
                            {% if problem.category %}
                            <div style="font-size:0.75rem; color:#888; text-transform:uppercase;">{{ problem.category }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if problem.severity >= 5 %}
                                <span class="severity-indicator severity-high"></span>–í—ã—Å–æ–∫–∞—è
                            {% elif problem.severity >= 3 %}
                                <span class="severity-indicator severity-mid"></span>–°—Ä–µ–¥–Ω—è—è
                            {% else %}
                                <span class="severity-indicator severity-low"></span>–ù–∏–∑–∫–∞—è
                            {% endif %}
                        </td>
                        <td>
                            {% if problem.status == 'reported' %}
                                <span class="status-badge status-pending">–ù–æ–≤–∞—è</span>
                            {% elif problem.status == 'in_progress' %}
                                <span class="status-badge status-reviewed">–í —Ä–∞–±–æ—Ç–µ</span>
                            {% else %}
                                <span class="status-badge status-resolved">–ì–æ—Ç–æ–≤–æ</span>
                            {% endif %}
                        </td>
                        <td><b style="color: var(--accent-yellow);">{{ problem.reward }}</b></td>
                        <td class="action-buttons">
                            {% if problem.status != 'completed' %}
                            <button class="btn-action btn-approve" onclick="markProblemComplete({{ problem.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                            <button class="btn-action btn-reject" onclick="deleteProblem({{ problem.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
    <div class="admin-section">
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        </div>
        
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–†–æ–ª—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>
                        <div style="font-weight:700;">{{ user.username }}</div>
                        <div style="font-size:0.8rem; color:#888;">{{ user.email }}</div>
                    </td>
                    <td>{{ user.points }} üü°</td>
                    <td>
                        <i class="fas fa-flag" style="color:#ccc;"></i> {{ user.total_reports }}
                        <i class="fas fa-check" style="color:#ccc; margin-left:5px;"></i> {{ user.total_completed }}
                    </td>
                    <td>
                        {% if user.is_admin %}
                            <span class="status-badge" style="background:var(--accent-red); color:white; border:none;">–ê–¥–º–∏–Ω</span>
                        {% elif user.is_worker %}
                            <span class="status-badge" style="background:var(--accent-yellow); color:black; border:none;">–†–∞–±–æ—Ç–Ω–∏–∫</span>
                        {% else %}
                            <span class="status-badge" style="background:#eee; color:#666; border:none;">–Æ–∑–µ—Ä</span>
                        {% endif %}
                    </td>
                    <td class="action-buttons">
                        {% if not user.is_admin %}
                        <button class="btn-action btn-view" onclick="toggleAdmin({{ user.id }})">
                            <i class="fas fa-user-shield"></i> –ü—Ä–∞–≤–∞
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∞–ª–æ–±
    async function resolveComplaint(complaintId, action) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?')) return;
        
        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º API –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∂–∞–ª–æ–±—ã
            // –î–ª—è –¥–µ–º–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É, –∫–æ—Ç–æ—Ä–∞—è —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É
            /* 
            const response = await fetch(`/api/complaints/${complaintId}/resolve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: action })
            });
            */
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            const row = document.getElementById(`complaint-row-${complaintId}`);
            if(row) {
                row.style.opacity = '0.5';
                setTimeout(() => row.remove(), 500);
            }
            alert('–ñ–∞–ª–æ–±–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ (' + action + ')');
            
        } catch (error) {
            console.error(error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ');
        }
    }
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    async function markProblemComplete(problemId) {
        if (!confirm('–ü–æ–º–µ—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω—É—é?')) return;
        
        try {
            const response = await fetch(`/api/problems/${problemId}/complete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            }
        } catch (error) {
            console.error(error);
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
    async function deleteProblem(problemId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
        
        // –í app.py –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ delete –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ, 
        // –Ω–æ —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∞–¥–º–∏–Ω—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è. –î–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É UI.
        alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–≤ –¥–µ–º–æ —Ä–µ–∂–∏–º–µ –∑–∞–ø–∏—Å—å —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è)');
        const row = document.getElementById(`problem-row-${problemId}`);
        if(row) row.remove();
    }
    
    // –°–º–µ–Ω–∞ –ø—Ä–∞–≤
    async function toggleAdmin(userId) {
        if (!confirm('–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        
        alert('–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        location.reload();
    }
</script>
{% endblock %}