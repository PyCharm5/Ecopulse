{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}
{% block extra_css %}
<style>
    :root {
        --primary-green: #1B4B43;  /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π */
        --bg-beige: #F2EFE4;       /* –ë–µ–∂–µ–≤—ã–π —Ñ–æ–Ω */
        --accent-red: #E74C3C;     /* –ö—Ä–∞—Å–Ω—ã–π */
        --accent-yellow: #F1C40F;  /* –ñ–µ–ª—Ç—ã–π */
        --accent-blue: #2980b9;    /* –°–∏–Ω–∏–π */
        --border-thick: 2px solid #1B4B43;
        --radius-main: 12px;
    }

    body {
        background-color: #fafafa;
        color: var(--primary-green);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .admin-header {
        background-color: var(--bg-beige);
        color: var(--primary-green);
        padding: 25px;
        border-radius: var(--radius-main);
        margin-bottom: 30px;
        border: var(--border-thick);
        box-shadow: 0 4px 0 rgba(27, 75, 67, 0.1);
    }
    
    .admin-header h1 {
        font-weight: 800;
        margin-bottom: 5px;
    }

    .lead {
        font-weight: 500;
        opacity: 0.8;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card-admin {
        background: white;
        border-radius: var(--radius-main);
        padding: 20px;
        text-align: center;
        border: var(--border-thick);
        transition: transform 0.2s;
    }

    .stat-card-admin:hover {
        transform: translateY(-3px);
    }
    
    .stat-card-admin i {
        margin-bottom: 10px;
        color: var(--primary-green) !important;
    }
    
    .stat-number-admin {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 10px 0;
        color: var(--primary-green);
    }

    .stat-card-admin p {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #666;
    }
    
    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã */
    .system-health {
        background: white;
        padding: 25px;
        border-radius: var(--radius-main);
        margin-bottom: 25px;
        border: var(--border-thick);
    }

    .health-indicator {
        height: 12px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
        border: 1px solid var(--primary-green);
    }
    
    .health-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }
    
    .health-good { background: #27AE60; }
    .health-warning { background: #F39C12; }
    .health-critical { background: #E74C3C; }

    /* –í–∫–ª–∞–¥–∫–∏ (Tabs) */
    .admin-tabs {
        border-bottom: 2px solid var(--primary-green);
        margin-bottom: 20px;
    }

    .admin-tabs .nav-link {
        color: var(--primary-green);
        font-weight: 700;
        border: none;
        background: transparent;
        padding: 12px 25px;
        opacity: 0.6;
    }
    
    .admin-tabs .nav-link:hover {
        opacity: 1;
    }

    .admin-tabs .nav-link.active {
        background: var(--bg-beige);
        color: var(--primary-green);
        opacity: 1;
        border-radius: 10px 10px 0 0;
        border: 2px solid var(--primary-green);
        border-bottom: none;
        margin-bottom: -2px;
        z-index: 1;
    }
    
    /* –¢–∞–±–ª–∏—Ü—ã */
    .table-responsive {
        background: white;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        overflow: hidden;
        padding: 5px;
        margin-bottom: 20px;
    }

    .table {
        margin-bottom: 0;
    }
    
    .table thead {
        background-color: var(--bg-beige);
        border-bottom: 2px solid var(--primary-green);
    }

    .table th {
        color: var(--primary-green);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
        border: none;
        padding: 12px 15px;
    }

    .table td {
        vertical-align: middle;
        font-weight: 500;
        color: #333;
        padding: 12px 15px;
        border-top: 1px solid #eee;
    }

    /* –ë–µ–π–¥–∂–∏ */
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    .bg-success { background-color: #27AE60 !important; }
    .bg-danger { background-color: var(--accent-red) !important; }
    .bg-warning { background-color: #F39C12 !important; color: white !important; }
    .bg-primary { background-color: var(--accent-blue) !important; }
    .bg-secondary { background-color: #95a5a6 !important; }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        border-radius: 20px;
        font-weight: 600;
        border: none;
        padding: 8px 16px;
        transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); }
    
    .btn-success { background-color: #27AE60; color: white; }
    .btn-primary { background-color: var(--primary-green); color: white; }
    .btn-info { background-color: #3498db; color: white; }
    .btn-danger { background-color: var(--accent-red); color: white; }
    .btn-warning { background-color: #F39C12; color: white; }

    .user-actions {
        white-space: nowrap;
    }

    .user-actions button {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 5px;
    }

    /* –ì—Ä–∞—Ñ–∏–∫–∏ */
    .card {
        border: var(--border-thick);
        border-radius: var(--radius-main);
        overflow: hidden;
        margin-bottom: 20px;
    }
    .card-header {
        background-color: var(--bg-beige);
        border-bottom: 2px solid var(--primary-green);
        font-weight: 700;
        color: var(--primary-green);
        padding: 15px 20px;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-cogs"></i> –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
    <p class="lead">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-cards">
    <div class="stat-card-admin">
        <i class="fas fa-users fa-2x"></i>
        <div class="stat-number-admin">{{ total_users }}</div>
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>
    
    <div class="stat-card-admin">
        <i class="fas fa-coins fa-2x"></i>
        <div class="stat-number-admin">{{ total_points }}</div>
        <p>–í—Å–µ–≥–æ –§–ú –≤ —Å–∏—Å—Ç–µ–º–µ</p>
    </div>
    
    <div class="stat-card-admin">
        <i class="fas fa-tasks fa-2x"></i>
        <div class="stat-number-admin">{{ total_tasks }}</div>
        <p>–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</p>
    </div>
    
    <div class="stat-card-admin">
        <i class="fas fa-calendar-day fa-2x"></i>
        <div class="stat-number-admin">{{ new_points_today }}</div>
        <p>–ù–æ–≤—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
    </div>
</div>

<!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã -->
<div class="system-health">
    <h5 style="font-weight: bold; color: var(--primary-green); margin-bottom: 20px;">
        <i class="fas fa-heartbeat"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
    </h5>
    <div class="row">
        <div class="col-md-3">
            <p style="font-weight: bold; margin-bottom: 5px;">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</p>
            <div class="health-indicator">
                <div class="health-bar health-good" style="width: 100%;"></div>
            </div>
            <small>{{ total_points + total_users + total_tasks }} –∑–∞–ø–∏—Å–µ–π</small>
        </div>
        <div class="col-md-3">
            <p style="font-weight: bold; margin-bottom: 5px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
            <div class="health-indicator">
                <div class="health-bar {% if new_points_today > 10 %}health-good{% elif new_points_today > 3 %}health-warning{% else %}health-critical{% endif %}" 
                     style="width: {% if new_points_today > 10 %}100{% elif new_points_today > 5 %}70{% elif new_points_today > 0 %}40{% else %}10{% endif %}%;">
                </div>
            </div>
            <small>{{ new_points_today }} –Ω–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</small>
        </div>
        <div class="col-md-3">
            <p style="font-weight: bold; margin-bottom: 5px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
            {% set completed = problems|selectattr('status', 'equalto', 'completed')|list|length %}
            {% set completion_rate = (completed / problems|length * 100) if problems|length > 0 else 0 %}
            <div class="health-indicator">
                <div class="health-bar {% if completion_rate > 50 %}health-good{% elif completion_rate > 20 %}health-warning{% else %}health-critical{% endif %}" 
                     style="width: {{ completion_rate|int }}%;">
                </div>
            </div>
            <small>{{ completion_rate|int }}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
        </div>
        <div class="col-md-3">
            <p style="font-weight: bold; margin-bottom: 5px;">–°–µ—Ä–≤–µ—Ä</p>
            <div class="health-indicator">
                <div class="health-bar health-good" style="width: 95%;"></div>
            </div>
            <small>–†–∞–±–æ—Ç–∞–µ—Ç {{ (now - problems[-1].created_at).days if problems else 0 }} –¥–Ω–µ–π</small>
        </div>
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
<ul class="nav nav-tabs admin-tabs" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
            <i class="fas fa-users"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button">
            <i class="fas fa-map-marker-alt"></i> –¢–æ—á–∫–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">
            <i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">
            <i class="fas fa-shopping-cart"></i> –ó–∞–∫–∞–∑—ã
        </button>
    </li>
	<li class="nav-item" role="presentation">
		<button class="nav-link" id="moderation-tab" data-bs-toggle="tab" data-bs-target="#moderation" type="button">
			<i class="fas fa-gavel"></i> –ú–æ–¥–µ—Ä–∞—Ü–∏—è
			<span id="pendingComplaintsBadge" class="badge bg-danger" style="display: none;">0</span>
		</button>
	</li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button">
            <i class="fas fa-microchip"></i> –°–µ–Ω—Å–æ—Ä—ã (IoT)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button">
            <i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">
    
    <!-- USERS TAB -->
    <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>Email</th>
                        <th>–ì–æ—Ä–æ–¥</th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th>–†–æ–ª—å</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥.</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>#{{ user.id }}</td>
                        <td>
                            <div style="font-weight:bold;">{{ user.username }}</div>
                            <div style="font-size:0.8rem; color:#888;">Lv. {{ user.level }}</div>
                        </td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.city }}</td>
                        <td><span class="badge" style="background:#F1C40F; color:black;">{{ user.points }} üü°</span></td>
                        <td>
                            {% if user.is_admin %}
                            <span class="badge bg-danger">–ê–¥–º–∏–Ω</span>
                            {% elif user.is_worker %}
                            <span class="badge bg-warning">–†–∞–±–æ—Ç–Ω–∏–∫</span>
                            {% else %}
                            <span class="badge bg-secondary">–Æ–∑–µ—Ä</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%d.%m.%Y') }}</td>
                        <td class="user-actions">
                            <button class="btn btn-sm btn-info" onclick="editUser({{ user.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="resetPassword({{ user.id }})" title="–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è"><i class="fas fa-key"></i></button>
                            {% if not user.is_admin %}
                            <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})" title="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- POINTS TAB -->
    <div class="tab-pane fade" id="points" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                        <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ê–≤—Ç–æ—Ä</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for point in points %}
                    <tr>
                        <td>#{{ point.id }}</td>
                        <td>
                            <strong>{{ point.title }}</strong><br>
                            <small class="text-muted">{{ point.description[:40] }}...</small>
                        </td>
                        <td><span class="badge bg-primary">{{ point.category }}</span></td>
                        <td>
                            {% if point.severity >= 5 %}
                            <span class="badge bg-danger">–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
                            {% elif point.severity >= 3 %}
                            <span class="badge bg-warning">–°—Ä–µ–¥–Ω–µ</span>
                            {% else %}
                            <span class="badge bg-success">–ù–∏–∑–∫–æ</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if point.status == 'active' or point.status == 'reported' %}
                            <span class="badge bg-warning">–ù–æ–≤–∞—è</span>
                            {% elif point.status == 'in_progress' %}
                            <span class="badge bg-info">–í —Ä–∞–±–æ—Ç–µ</span>
                            {% elif point.status == 'completed' %}
                            <span class="badge bg-success">–ì–æ—Ç–æ–≤–æ</span>
                            {% endif %}
                        </td>
                        <td>{{ point.user.username }}</td>
                        <td>{{ point.created_at.strftime('%d.%m.%Y') }}</td>
                        <td class="user-actions">
                            <button class="btn btn-sm btn-info" onclick="editPoint({{ point.id }})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deletePoint({{ point.id }})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- TASKS TAB -->
    <div class="tab-pane fade" id="tasks" role="tabpanel">
        <div class="export-buttons">
            <button class="btn btn-primary" onclick="createTask()"><i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                        <th>–°—Ä–æ–∫</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.id }}</td>
                        <td>
                            {{ task.description }}
                            {% if task.point %}
                            <br><small class="text-muted">–¢–æ—á–∫–∞: {{ task.point.title }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if task.status == 'pending' %}
                            <span class="badge bg-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                            {% elif task.status == 'in_progress' %}
                            <span class="badge bg-info">–í —Ä–∞–±–æ—Ç–µ</span>
                            {% endif %}
                        </td>
                        <td>{{ task.worker.username if task.worker else '‚Äî' }}</td>
                        <td>‚Äî</td>
                        <td class="user-actions">
                            <button class="btn btn-sm btn-info"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ORDERS TAB -->
    <div class="tab-pane fade" id="orders" role="tabpanel">
        <div class="export-buttons">
            <button class="btn btn-success" onclick="loadOrders()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ö–æ–ª-–≤–æ</th>
                        <th>–ò—Ç–æ–≥–æ</th>
                        <th>–ê–¥—Ä–µ—Å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr><td colspan="11" class="text-center">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
	<!-- MODERATION TAB -->
	<div class="tab-pane fade" id="moderation" role="tabpanel">
		<div class="export-buttons">
			<button class="btn btn-success" onclick="loadComplaints()">
				<i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
			</button>
			<button class="btn btn-info" onclick="showComplaintStats()">
				<i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
			</button>
		</div>
		
		<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–∞–ª–æ–± -->
		<div id="complaintStats" class="card mb-3" style="display: none;">
			<div class="card-header">
				<i class="fas fa-chart-pie"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–∞–ª–æ–±
			</div>
			<div class="card-body">
				<div class="row" id="statsContent">
					<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
				</div>
			</div>
		</div>
		
		<!-- –§–∏–ª—å—Ç—Ä—ã -->
		<div class="row mb-3">
			<div class="col-md-3">
				<select class="form-select" id="complaintFilter" onchange="filterComplaints()">
					<option value="all">–í—Å–µ –∂–∞–ª–æ–±—ã</option>
					<option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
					<option value="resolved">–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</option>
					<option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
				</select>
			</div>
			<div class="col-md-3">
				<select class="form-select" id="reasonFilter" onchange="filterComplaints()">
					<option value="all">–í—Å–µ –ø—Ä–∏—á–∏–Ω—ã</option>
					<option value="spam">–°–ø–∞–º/–†–µ–∫–ª–∞–º–∞</option>
					<option value="fake">–§–µ–π–∫</option>
					<option value="offensive">–û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω–æ</option>
					<option value="duplicate">–î—É–±–ª–∏–∫–∞—Ç</option>
					<option value="other">–î—Ä—É–≥–æ–µ</option>
				</select>
			</div>
		</div>
		
		<!-- –¢–∞–±–ª–∏—Ü–∞ –∂–∞–ª–æ–± -->
		<div class="table-responsive">
			<table class="table table-hover">
				<thead>
					<tr>
						<th>ID</th>
						<th>–ü—Ä–æ–±–ª–µ–º–∞</th>
						<th>–ü—Ä–∏—á–∏–Ω–∞</th>
						<th>–ñ–∞–ª–æ–±—â–∏–∫</th>
						<th>–î–∞—Ç–∞</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–î–µ–π—Å—Ç–≤–∏—è</th>
					</tr>
				</thead>
				<tbody id="complaintsTableBody">
					<tr><td colspan="7" class="text-center">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±</td></tr>
				</tbody>
			</table>
		</div>
		
		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã -->
		<div class="modal fade" id="resolveComplaintModal" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header" style="background: var(--primary-green); color: white;">
						<h5 class="modal-title"><i class="fas fa-gavel"></i> –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∞–ª–æ–±—ã #<span id="modalComplaintId"></span></h5>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="currentComplaintId">
						
						<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∂–∞–ª–æ–±–µ -->
						<div class="mb-4">
							<h6>–î–µ—Ç–∞–ª–∏ –∂–∞–ª–æ–±—ã:</h6>
							<div id="complaintDetails" class="p-3 bg-light rounded">
								<!-- –ó–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
							</div>
						</div>
						
						<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–ª–µ–º–µ -->
						<div class="mb-4">
							<h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–ª–µ–º–µ:</h6>
							<div id="problemDetails" class="p-3 bg-light rounded">
								<!-- –ó–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
							</div>
						</div>
						
						<!-- –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è -->
						<div class="mb-3">
							<label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</label>
							<select class="form-select" id="complaintAction" onchange="updateActionWarning()">
								<option value="delete_problem">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É</option>
								<option value="reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∂–∞–ª–æ–±—É (–Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è)</option>
								<option value="ignore">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é (–±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—è)</option>
							</select>
							
							<div class="alert alert-warning mt-2" id="deleteWarning" style="display: none;">
								<i class="fas fa-exclamation-triangle"></i>
								<strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ü—Ä–æ–±–ª–µ–º–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞ –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –∏ –≥–æ–ª–æ—Å–∞–º–∏. –ê–≤—Ç–æ—Ä—É –±—É–¥—É—Ç —Å–Ω—è—Ç—ã –±–∞–ª–ª—ã.
							</div>
						</div>
						
						<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∞ -->
						<div class="mb-3">
							<label class="form-label fw-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</label>
							<textarea class="form-control" id="adminComment" rows="3" 
									  placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–∏–Ω—è—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è..."></textarea>
							<small class="text-muted">–≠—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.</small>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
						<button type="button" class="btn btn-success" onclick="processComplaintAction()">
							<i class="fas fa-check"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	
    <!-- SENSORS TAB -->
    <div class="tab-pane fade" id="sensors" role="tabpanel">
        <div class="export-buttons">
            <button class="btn btn-success" onclick="refreshSensors()"><i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <button class="btn btn-warning" onclick="calibrateSensors()"><i class="fas fa-tools"></i> –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</button>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-thermometer-half"></i> –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (OpenWeather)
                    </div>
                    <div class="card-body">
                        <canvas id="temperatureChart" style="height: 250px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-leaf"></i> –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ / –í–ª–∞–∂–Ω–æ—Å—Ç—å
                    </div>
                    <div class="card-body">
                        <canvas id="humidityChart" style="height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID –î–∞—Ç—á–∏–∫–∞</th>
                        <th>–¢–∏–ø</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                        <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="sensorsTableBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    <tr><td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- EXPORT TAB -->
    <div class="tab-pane fade" id="export" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </div>
                    <div class="card-body">
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞:</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="exportData('all', 'csv')">
                                <i class="fas fa-file-csv"></i> –°–∫–∞—á–∞—Ç—å CSV (Excel)
                            </button>
                            <button class="btn btn-info" onclick="exportData('all', 'json')">
                                <i class="fas fa-file-code"></i> –°–∫–∞—á–∞—Ç—å JSON
                            </button>
                            <button class="btn btn-primary" onclick="exportData('all', 'pdf')">
                                <i class="fas fa-file-pdf"></i> –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ì—Ä–∞—Ñ–∏–∫–∏
    let tempChart, humidityChart;
    
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        loadSensorsData();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        setInterval(loadSensorsData, 60000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        document.getElementById('orders-tab').addEventListener('shown.bs.tab', function() {
            loadOrders();
        });
    });
    
    function initCharts() {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        tempChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)',
                    data: [],
                    borderColor: '#E74C3C',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏/–≤–æ–∑–¥—É—Ö–∞
        const humCtx = document.getElementById('humidityChart').getContext('2d');
        humidityChart = new Chart(humCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '–≠–∫–æ-–∏–Ω–¥–µ–∫—Å / –í–ª–∞–∂–Ω–æ—Å—Ç—å',
                    data: [],
                    borderColor: '#27AE60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }
    
    async function loadSensorsData() {
		try {
			// –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞
			const lat = localStorage.getItem('cityLat') || 53.9925;
			const lng = localStorage.getItem('cityLng') || 86.6669;
			
			console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤ –¥–ª—è: ${lat}, ${lng}`);
			
			const response = await fetch(`/api/sensors?lat=${lat}&lng=${lng}`);
			const sensors = await response.json();
			
			updateTable(sensors);
			updateCharts(sensors);
			
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–Ω—Å–æ—Ä–æ–≤:', e);
			document.getElementById('sensorsTableBody').innerHTML = 
				'<tr><td colspan="7" class="text-center text-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API: ' + e.message + '</td></tr>';
		}
	}
    
    function updateTable(sensors) {
        const tbody = document.getElementById('sensorsTableBody');
        tbody.innerHTML = '';
        
        if (sensors.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        
        sensors.forEach(s => {
            let unit = '';
            if (s.sensor_type === 'temperature') unit = '¬∞C';
            else if (s.sensor_type === 'soil_moisture') unit = '%';
            
            const date = new Date(s.timestamp).toLocaleTimeString();
            
            tbody.innerHTML += `
                <tr>
                    <td>${s.sensor_id}</td>
                    <td>${s.sensor_type}</td>
                    <td><strong>${s.value}${unit}</strong></td>
                    <td><span class="badge bg-success">–û–Ω–ª–∞–π–Ω</span></td>
                    <td>${date}</td>
                    <td>${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}</td>
                    <td class="user-actions">
                        <button class="btn btn-sm btn-info" title="–î–µ—Ç–∞–ª–∏"><i class="fas fa-chart-line"></i></button>
                        <button class="btn btn-sm btn-warning" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i class="fas fa-cog"></i></button>
                    </td>
                </tr>
            `;
        });
    }
    
    function updateCharts(data) {
        const timeLabel = new Date().toLocaleTimeString();
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        const tempSensor = data.find(s => s.sensor_type === 'temperature');
        const humSensor = data.find(s => s.sensor_type === 'soil_moisture');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        if (tempSensor) {
            addDataToChart(tempChart, timeLabel, tempSensor.value);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
        if (humSensor) {
            addDataToChart(humidityChart, timeLabel, humSensor.value);
        }
    }
    
    function addDataToChart(chart, label, data) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });
        
        // –î–µ—Ä–∂–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç–æ—á–µ–∫
        if (chart.data.labels.length > 10) {
            chart.data.labels.shift();
            chart.data.datasets.forEach((dataset) => {
                dataset.data.shift();
            });
        }
        chart.update();
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏
    async function loadOrders() {
		try {
			const response = await fetch('/api/orders');
			const orders = await response.json();
			updateOrdersTable(orders);
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', e);
			document.getElementById('ordersTableBody').innerHTML = 
				'<tr><td colspan="11" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ' + e.message + '</td></tr>';
		}
	}
    
    function updateOrdersTable(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const statusColors = {
                'pending': 'warning',
                'processing': 'info',
                'shipped': 'primary',
                'delivered': 'success',
                'cancelled': 'danger'
            };
            
            const statusText = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'processing': '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                'shipped': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            
            const statusBadge = `<span class="badge bg-${statusColors[order.status] || 'secondary'}">${statusText[order.status] || order.status}</span>`;
            
            tbody.innerHTML += `
                <tr id="order-row-${order.id}">
                    <td>#${order.id}</td>
                    <td>${order.user}</td>
                    <td>${order.item}</td>
                    <td>${order.price} üü°</td>
                    <td>${order.quantity}</td>
                    <td><strong>${order.total} üü°</strong></td>
                    <td>
                        <div style="max-width: 200px; font-size: 0.85rem;">
                            ${order.address ? order.address.substring(0, 50) + (order.address.length > 50 ? '...' : '') : '‚Äî'}
                        </div>
                    </td>
                    <td>${order.phone || '‚Äî'}</td>
                    <td>${statusBadge}</td>
                    <td>${order.created_at}</td>
                    <td class="user-actions">
                        <button class="btn btn-sm btn-info" onclick="updateOrderStatus(${order.id}, 'processing')" title="–í –æ–±—Ä–∞–±–æ—Ç–∫—É">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="updateOrderStatus(${order.id}, 'delivered')" title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="updateOrderStatus(${order.id}, 'cancelled')" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    async function updateOrderStatus(orderId, status) {
        if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${orderId} –Ω–∞ "${status}"?`)) return;
        
        try {
            const response = await fetch(`/api/orders/${orderId}/update_status`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: status })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', `–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #${orderId} –æ–±–Ω–æ–≤–ª–µ–Ω`);
                loadOrders(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', result.message);
            }
        } catch (e) {
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }
    
    async function refreshSensors() {
        loadSensorsData();
        showNotification('info', '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    }
    
    // –†–µ–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
    async function editUser(id) {
        const points = prompt('–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤:');
        if (points !== null) {
            try {
                const response = await fetch(`/api/user/${id}/edit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ points: parseInt(points) })
                });
                
                if (response.ok) {
                    showNotification('success', '–£—Å–ø–µ—Ö', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (e) {
                showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            }
        }
    }
    
    async function deleteUser(id) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ?')) return;
        
        try {
            const response = await fetch(`/api/user/${id}/delete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('error', '–û—à–∏–±–∫–∞', data.message);
            }
        } catch (e) {
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    }
    
    async function resetPassword(id) {
        if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
        
        try {
            const response = await fetch(`/api/user/${id}/reset_password`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', `–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ${data.password}`);
            }
        } catch (e) {
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞');
        }
    }
    
    async function deletePoint(id) {
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É?')) return;
        
        try {
            const response = await fetch(`/api/problems/${id}/delete`, { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('success', '–£—Å–ø–µ—Ö', '–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (e) {
            showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    }
    
    async function editPoint(id) {
        const title = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:');
        const reward = prompt('–ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞:');
        
        if (title !== null && reward !== null) {
            try {
                const response = await fetch(`/api/problems/${id}/edit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        title: title,
                        reward: parseInt(reward)
                    })
                });
                
                if (response.ok) {
                    showNotification('success', '–£—Å–ø–µ—Ö', '–¢–æ—á–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    setTimeout(() => location.reload(), 1000);
            }
            } catch (e) {
                showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            }
        }
    }
    
    function createTask() {
        const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:');
        const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:');
        const reward = prompt('–ù–∞–≥—Ä–∞–¥–∞ (–±–∞–ª–ª—ã):');
        
        if (title && description && reward) {
            fetch('/api/tasks/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title,
                    description: description,
                    reward: parseInt(reward),
                    category: 'other',
                    severity: 3
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotification('success', '–£—Å–ø–µ—Ö', '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(e => showNotification('error', '–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è'));
        }
    }
    
    // –ó–∞–≥–ª—É—à–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π
    function calibrateSensors() { 
        showNotification('info', '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞...');
    }
    function exportData(type, format) { 
        showNotification('info', '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', `–≠–∫—Å–ø–æ—Ä—Ç ${type} –≤ —Ñ–æ—Ä–º–∞—Ç–µ ${format} (–∑–∞–≥–ª—É—à–∫–∞)`);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤ base.html)
    function showNotification(type, title, message) {
        // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ base.html, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
        if (typeof window.showAlert === 'function') {
            window.showAlert(type, title, message);
        } else {
            // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            alert(`${title}: ${message}`);
        }
    }

	// ==========================================
	// –ú–û–î–ï–†–ê–¶–ò–Ø –ñ–ê–õ–û–ë
	// ==========================================

	let complaintsData = [];

	// –ó–∞–≥—Ä—É–∑–∫–∞ –∂–∞–ª–æ–±
	async function loadComplaints() {
		try {
			showNotification('info', '–ó–∞–≥—Ä—É–∑–∫–∞', '–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∞–ª–æ–±...');
			
			const response = await fetch('/api/complaints/all');
			if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
			
			complaintsData = await response.json();
			renderComplaintsTable(complaintsData);
			updatePendingBadge();
			
			showNotification('success', '–£—Å–ø–µ—Ö', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${complaintsData.length} –∂–∞–ª–æ–±`);
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±:', e);
			document.getElementById('complaintsTableBody').innerHTML = 
				'<tr><td colspan="7" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂–∞–ª–æ–±: ' + e.message + '</td></tr>';
			showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∂–∞–ª–æ–±—ã');
		}
	}

	// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∂–∞–ª–æ–±
	function renderComplaintsTable(complaints) {
		const tbody = document.getElementById('complaintsTableBody');
		
		if (complaints.length === 0) {
			tbody.innerHTML = '<tr><td colspan="7" class="text-center">–ù–µ—Ç –∂–∞–ª–æ–± –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
			return;
		}
		
		let html = '';
		
		complaints.forEach(complaint => {
			// –°—Ç–∞—Ç—É—Å
			let statusBadge = '';
			if (complaint.status === 'pending') {
				statusBadge = '<span class="badge bg-warning">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>';
			} else if (complaint.status === 'resolved') {
				statusBadge = '<span class="badge bg-success">–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞</span>';
			} else {
				statusBadge = '<span class="badge bg-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>';
			}
			
			// –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
			const problemTitle = complaint.problem_title && complaint.problem_title.length > 30 ? 
				complaint.problem_title.substring(0, 30) + '...' : 
				(complaint.problem_title || '–ü—Ä–æ–±–ª–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞');
			
			// –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
			let actionButtons = '';
			if (complaint.status === 'pending') {
				actionButtons = `
					<button class="btn btn-sm btn-primary" onclick="openResolveModal(${complaint.id})" title="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å">
						<i class="fas fa-cog"></i>
					</button>
					<button class="btn btn-sm btn-danger" onclick="quickRejectComplaint(${complaint.id})" title="–ë—ã—Å—Ç—Ä–æ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å">
						<i class="fas fa-times"></i>
					</button>
				`;
			} else {
				actionButtons = `
					<button class="btn btn-sm btn-info" onclick="viewComplaintDetails(${complaint.id})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
						<i class="fas fa-eye"></i>
					</button>
					<button class="btn btn-sm btn-danger" onclick="deleteComplaint(${complaint.id})" title="–£–¥–∞–ª–∏—Ç—å">
						<i class="fas fa-trash"></i>
					</button>
				`;
			}
			
			html += `
				<tr id="complaint-row-${complaint.id}">
					<td>#${complaint.id}</td>
					<td>
						<strong>${problemTitle}</strong><br>
						<small class="text-muted">ID: ${complaint.problem_id} | –°—Ç–∞—Ç—É—Å: ${complaint.problem_status || '—É–¥–∞–ª–µ–Ω–∞'}</small>
					</td>
					<td>${complaint.reason_text}</td>
					<td>${complaint.user}</td>
					<td>${complaint.created_at}</td>
					<td>${statusBadge}</td>
					<td class="user-actions">${actionButtons}</td>
				</tr>
			`;
		});
		
		tbody.innerHTML = html;
	}

	// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∂–∞–ª–æ–± (—É–±—Ä–∞–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
	function filterComplaints() {
		const statusFilter = document.getElementById('complaintFilter').value;
		const reasonFilter = document.getElementById('reasonFilter').value;
		
		let filtered = complaintsData;
		
		// –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
		if (statusFilter !== 'all') {
			filtered = filtered.filter(c => c.status === statusFilter);
		}
		
		// –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–∏—á–∏–Ω–µ
		if (reasonFilter !== 'all') {
			filtered = filtered.filter(c => c.reason === reasonFilter);
		}
		
		renderComplaintsTable(filtered);
	}

	// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–∂–∏–¥–∞—é—â–∏—Ö –∂–∞–ª–æ–±
	function updatePendingBadge() {
		const pendingCount = complaintsData.filter(c => c.status === 'pending').length;
		const badge = document.getElementById('pendingComplaintsBadge');
		
		if (pendingCount > 0) {
			badge.textContent = pendingCount;
			badge.style.display = 'inline-block';
		} else {
			badge.style.display = 'none';
		}
	}

	// –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∂–∞–ª–æ–±
	async function showComplaintStats() {
		const statsDiv = document.getElementById('complaintStats');
		const contentDiv = document.getElementById('statsContent');
		
		if (statsDiv.style.display === 'none') {
			contentDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>';
			statsDiv.style.display = 'block';
			
			try {
				const response = await fetch('/api/complaints/stats');
				const stats = await response.json();
				
				let html = `
					<div class="col-md-3">
						<div class="stat-card-admin">
							<i class="fas fa-flag fa-2x"></i>
							<div class="stat-number-admin">${stats.total}</div>
							<p>–í—Å–µ–≥–æ –∂–∞–ª–æ–±</p>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stat-card-admin" style="background: #FFF3E0;">
							<i class="fas fa-clock fa-2x" style="color: #E67E22;"></i>
							<div class="stat-number-admin" style="color: #E67E22;">${stats.pending}</div>
							<p>–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</p>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stat-card-admin" style="background: #E8F5E9;">
							<i class="fas fa-check fa-2x" style="color: #27AE60;"></i>
							<div class="stat-number-admin" style="color: #27AE60;">${stats.resolved}</div>
							<p>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</p>
						</div>
					</div>
					<div class="col-md-3">
						<div class="stat-card-admin" style="background: #FFEBEE;">
							<i class="fas fa-times fa-2x" style="color: #E74C3C;"></i>
							<div class="stat-number-admin" style="color: #E74C3C;">${stats.rejected}</div>
							<p>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</p>
						</div>
					</div>
				`;
				
				// –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º
				if (stats.reasons && Object.keys(stats.reasons).length > 0) {
					html += `
						<div class="col-md-12 mt-3">
							<h6>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º (–∑–∞ 30 –¥–Ω–µ–π):</h6>
							<div class="row">
					`;
					
					for (const [reason, count] of Object.entries(stats.reasons)) {
						const reasonText = {
							'spam': '–°–ø–∞–º',
							'fake': '–§–µ–π–∫',
							'offensive': '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è',
							'duplicate': '–î—É–±–ª–∏–∫–∞—Ç',
							'other': '–î—Ä—É–≥–æ–µ'
						}[reason] || reason;
						
						html += `
							<div class="col-md-2">
								<div class="text-center p-2 border rounded">
									<div class="fw-bold">${reasonText}</div>
									<div class="text-primary fw-bold">${count}</div>
								</div>
							</div>
						`;
					}
					
					html += `</div></div>`;
				}
				
				contentDiv.innerHTML = html;
			} catch (e) {
				contentDiv.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
			}
		} else {
			statsDiv.style.display = 'none';
		}
	}

	// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã
	async function openResolveModal(complaintId) {
		const complaint = complaintsData.find(c => c.id === complaintId);
		if (!complaint) {
			showNotification('error', '–û—à–∏–±–∫–∞', '–ñ–∞–ª–æ–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
			return;
		}
		
		document.getElementById('currentComplaintId').value = complaintId;
		document.getElementById('modalComplaintId').textContent = complaintId;
		
		// –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–∞–ª–æ–±–µ
		const complaintDetails = `
			<strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> ${complaint.reason_text}<br>
			<strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${complaint.description || '‚Äî'}<br>
			<strong>–ñ–∞–ª–æ–±—â–∏–∫:</strong> ${complaint.user}<br>
			<strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${complaint.created_at}
		`;
		
		// –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–±–ª–µ–º–µ
		const problemDetails = `
			<strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${complaint.problem_title || '–ü—Ä–æ–±–ª–µ–º–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞'}<br>
			<strong>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–±–ª–µ–º—ã:</strong> ${complaint.problem_status || '—É–¥–∞–ª–µ–Ω–∞'}<br>
			<strong>–ê–≤—Ç–æ—Ä:</strong> ${complaint.problem_user || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
			<strong>ID –ø—Ä–æ–±–ª–µ–º—ã:</strong> ${complaint.problem_id}
		`;
		
		document.getElementById('complaintDetails').innerHTML = complaintDetails;
		document.getElementById('problemDetails').innerHTML = problemDetails;
		document.getElementById('adminComment').value = '';
		document.getElementById('complaintAction').value = 'delete_problem';
		updateActionWarning();
		
		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		const modal = new bootstrap.Modal(document.getElementById('resolveComplaintModal'));
		modal.show();
	}

	// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
	function updateActionWarning() {
		const action = document.getElementById('complaintAction').value;
		const deleteWarning = document.getElementById('deleteWarning');
		
		// –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ warning
		deleteWarning.style.display = action === 'delete_problem' ? 'block' : 'none';
		
		// –£–±–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç warningAlert –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
		const warningAlert = document.getElementById('warningAlert');
		if (warningAlert) {
			warningAlert.style.display = 'none';
		}
	}

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
	async function processComplaintAction() {
		const complaintId = document.getElementById('currentComplaintId').value;
		const action = document.getElementById('complaintAction').value;
		const adminComment = document.getElementById('adminComment').value;
		
		const actionTexts = {
			'delete_problem': '–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
			'reject': '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∂–∞–ª–æ–±—É',
			'ignore': '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é'
		};
		
		if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ: "${actionTexts[action] || action}"?`)) {
			return;
		}
		
		try {
			const response = await fetch(`/api/complaints/${complaintId}/resolve`, {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({
					action: action,
					admin_comment: adminComment
				})
			});
			
			const result = await response.json();
			
			if (result.status === 'success') {
				showNotification('success', '–£—Å–ø–µ—Ö', '–ñ–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
				
				// –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
				if (action === 'delete_problem') {
					refreshMapMarkers();
				}
				
				// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
				const modal = bootstrap.Modal.getInstance(document.getElementById('resolveComplaintModal'));
				modal.hide();
				
				// –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∂–∞–ª–æ–±
				setTimeout(loadComplaints, 500);
			} else {
				showNotification('error', '–û—à–∏–±–∫–∞', result.message || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã');
			}
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±—ã:', e);
			showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∂–∞–ª–æ–±—É');
		}
	}

	// –ë—ã—Å—Ç—Ä–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∂–∞–ª–æ–±—ã
	async function quickRejectComplaint(complaintId) {
		if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∂–∞–ª–æ–±—É –∫–∞–∫ –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é?')) {
			return;
		}
		
		try {
			const response = await fetch(`/api/complaints/${complaintId}/reject`, {
				method: 'POST'
			});
			
			const result = await response.json();
			
			if (result.status === 'success') {
				showNotification('success', '–£—Å–ø–µ—Ö', '–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
				
				// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
				const row = document.getElementById(`complaint-row-${complaintId}`);
				if (row) {
					const statusCell = row.cells[5];
					statusCell.innerHTML = '<span class="badge bg-danger">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>';
					
					// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
					const actionsCell = row.cells[6];
					actionsCell.innerHTML = `
						<button class="btn btn-sm btn-info" onclick="viewComplaintDetails(${complaintId})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
							<i class="fas fa-eye"></i>
						</button>
						<button class="btn btn-sm btn-danger" onclick="deleteComplaint(${complaintId})" title="–£–¥–∞–ª–∏—Ç—å">
							<i class="fas fa-trash"></i>
						</button>
					`;
				}
				
				updatePendingBadge();
			} else {
				showNotification('error', '–û—à–∏–±–∫–∞', result.message || '–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∂–∞–ª–æ–±—ã');
			}
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', e);
			showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∂–∞–ª–æ–±—É');
		}
	}

	// –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π –∂–∞–ª–æ–±—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û)
	function viewComplaintDetails(complaintId) {
		const complaint = complaintsData.find(c => c.id === complaintId);
		if (!complaint) {
			showNotification('error', '–û—à–∏–±–∫–∞', '–ñ–∞–ª–æ–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
			return;
		}
		
		// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –±–µ–∑ HTML —Ç–µ–≥–æ–≤
		let details = `ID –∂–∞–ª–æ–±—ã: #${complaint.id}\n`;
		details += `–ü—Ä–æ–±–ª–µ–º–∞: ${complaint.problem_title || '–ü—Ä–æ–±–ª–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞'}\n`;
		details += `ID –ø—Ä–æ–±–ª–µ–º—ã: ${complaint.problem_id}\n`;
		details += `–ü—Ä–∏—á–∏–Ω–∞: ${complaint.reason_text}\n`;
		details += `–û–ø–∏—Å–∞–Ω–∏–µ: ${complaint.description || '‚Äî'}\n`;
		details += `–ñ–∞–ª–æ–±—â–∏–∫: ${complaint.user}\n`;
		details += `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${complaint.created_at}\n`;
		details += `–°—Ç–∞—Ç—É—Å: ${complaint.status_text}\n`;
		
		if (complaint.resolved_at) {
			details += `–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${complaint.resolved_at}\n`;
			details += `–û–±—Ä–∞–±–æ—Ç–∞–ª: ${complaint.resolved_by || '–°–∏—Å—Ç–µ–º–∞'}\n`;
			if (complaint.admin_comment) {
				details += `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞: ${complaint.admin_comment}\n`;
			}
		}
		
		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ
		const modalHtml = `
			<div class="modal fade" id="viewComplaintModal" tabindex="-1">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –∂–∞–ª–æ–±—ã #${complaint.id}</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 10px; border-radius: 5px;">${details}</pre>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
						</div>
					</div>
				</div>
			</div>
		`;
		
		// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –µ—Å–ª–∏ –µ—Å—Ç—å
		const oldModal = document.getElementById('viewComplaintModal');
		if (oldModal) oldModal.remove();
		
		// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π
		document.body.insertAdjacentHTML('beforeend', modalHtml);
		
		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–π
		const modal = new bootstrap.Modal(document.getElementById('viewComplaintModal'));
		modal.show();
	}

	// –£–¥–∞–ª–µ–Ω–∏–µ –∂–∞–ª–æ–±—ã
	async function deleteComplaint(complaintId) {
		if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∂–∞–ª–æ–±—É –∏–∑ —Å–∏—Å—Ç–µ–º—ã?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
			return;
		}
		
		try {
			const response = await fetch(`/api/complaints/${complaintId}/delete`, {
				method: 'POST'
			});
			
			const result = await response.json();
			
			if (result.status === 'success') {
				showNotification('success', '–£—Å–ø–µ—Ö', '–ñ–∞–ª–æ–±–∞ —É–¥–∞–ª–µ–Ω–∞');
				
				// –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
				const row = document.getElementById(`complaint-row-${complaintId}`);
				if (row) {
					row.remove();
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
				complaintsData = complaintsData.filter(c => c.id !== complaintId);
				updatePendingBadge();
			} else {
				showNotification('error', '–û—à–∏–±–∫–∞', result.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã');
			}
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', e);
			showNotification('error', '–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∂–∞–ª–æ–±—É');
		}
	}

	// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∂–∞–ª–æ–± –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
	document.getElementById('moderation-tab').addEventListener('shown.bs.tab', function() {
		loadComplaints();
	});
	
	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
	async function refreshMapMarkers() {
		try {
			// –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
			if (window.opener && typeof window.opener.refreshMapFromAdmin === 'function') {
				window.opener.refreshMapFromAdmin();
			}
			
			// –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç–µ)
			if (typeof window.refreshMapFromAdmin === 'function') {
				window.refreshMapFromAdmin();
			}
			
			// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ iframe –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
			setTimeout(() => {
				// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç
				window.dispatchEvent(new CustomEvent('mapNeedsRefresh'));
			}, 100);
			
			console.log('–ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã');
			
		} catch (e) {
			console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã:', e);
		}
	}
		
</script>
{% endblock %}
