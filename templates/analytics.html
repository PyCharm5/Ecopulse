{% extends "base.html" %}
{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - {{ city_name }}{% endblock %}
{% block extra_css %}
<style>
    :root {
        --primary-green: #1B4B43;
        --bg-beige: #F2EFE4;
        --accent-red: #E74C3C;
        --accent-yellow: #F1C40F;
        --accent-blue: #2980b9;
        --border-thick: 2px solid #1B4B43;
        --radius-main: 12px;
    }

    body {
        background-color: #fafafa;
        color: var(--primary-green);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .analytics-header {
        background-color: var(--bg-beige);
        padding: 30px;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        margin-bottom: 30px;
        box-shadow: 0 4px 0 rgba(27, 75, 67, 0.1);
        text-align: center;
    }

    .analytics-header h1 {
        font-weight: 800;
        margin-bottom: 10px;
        font-size: 2rem;
    }

    .lead {
        font-weight: 500;
        opacity: 0.8;
        margin: 0;
    }

    /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–≤–µ—Ä—Ö–Ω—è—è) */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: var(--radius-main);
        padding: 25px;
        border: var(--border-thick);
        text-align: center;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-card h3 {
        color: var(--primary-green);
        margin-bottom: 10px;
        font-size: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .stat-number {
        font-size: 3rem;
        font-weight: 800;
        color: var(--primary-green);
        margin: 5px 0;
        line-height: 1;
    }
    
    .stat-card p {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
    }

    /* –°–µ–∫—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .chart-header {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
    .top-users-section {
        background: white;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        padding: 25px;
        margin-bottom: 30px;
    }

    .user-rank-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .user-rank-item:last-child { border-bottom: none; }
    .user-rank-item:hover { background: #fcfcfc; }

    .rank-num {
        width: 35px;
        height: 35px;
        background: var(--bg-beige);
        color: var(--primary-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        margin-right: 15px;
    }

    .rank-1 { background: #F1C40F; color: white; }
    .rank-2 { background: #bdc3c7; color: white; }
    .rank-3 { background: #e67e22; color: white; }

    /* –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ */
    .table-container {
        background: white;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }
    
    th {
        background: var(--bg-beige);
        color: var(--primary-green);
        font-weight: 700;
        padding: 15px;
        text-align: left;
        border-bottom: 2px solid var(--primary-green);
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        color: #333;
    }
    
    tr:last-child td { border-bottom: none; }
    
    /* –ë–µ–π–¥–∂–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .badge-custom {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .cat-pollution { background: #ffebee; color: var(--accent-red); }
    .cat-plants { background: #e8f5e9; color: #27AE60; }
    .cat-water { background: #e3f2fd; color: var(--accent-blue); }
    .cat-other { background: #f5f5f5; color: #666; }

    .status-completed { color: #27AE60; font-weight: bold; }
    .status-in_progress { color: #F39C12; font-weight: bold; }
    .status-reported { color: var(--accent-red); font-weight: bold; }

    @media (max-width: 768px) {
        .charts-row { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="analytics-header">
    <h1><i class="fas fa-chart-line"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: {{ city_name }}</h1>
    <p class="lead">–û–±–∑–æ—Ä —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å—Ä–µ–¥—ã</p>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="stats-grid">
    <div class="stat-card">
        <h3><i class="fas fa-map-marker-alt"></i> –í—Å–µ–≥–æ —Ç–æ—á–µ–∫</h3>
        <div class="stat-number">{{ total_points }}</div>
        <p>–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–±–ª–µ–º</p>
    </div>
    
    <div class="stat-card">
        <h3><i class="fas fa-exclamation-circle" style="color:var(--accent-red);"></i> –ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
        <div class="stat-number" style="color:var(--accent-red);">{{ active_points }}</div>
        <p>–¢—Ä–µ–±—É—é—Ç —Ä–µ—à–µ–Ω–∏—è</p>
    </div>
    
    <div class="stat-card">
        <h3><i class="fas fa-check-circle" style="color:#27AE60;"></i> –†–µ—à–µ–Ω–æ</h3>
        <div class="stat-number" style="color:#27AE60;">{{ completed_points }}</div>
        <p>–£—Å–ø–µ—à–Ω—ã—Ö –∫–µ–π—Å–æ–≤</p>
    </div>
    
    <div class="stat-card">
        <h3><i class="fas fa-users"></i> –ê–∫—Ç–∏–≤–∏—Å—Ç–æ–≤</h3>
        <div class="stat-number" style="color:var(--accent-blue);">{{ active_users|length }}</div>
        <p>–í —Ç–æ–ø–µ —Ä–µ–π—Ç–∏–Ω–≥–∞</p>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div class="charts-row">
    <div class="chart-card">
        <div class="chart-header">
            <i class="fas fa-chart-pie"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º
        </div>
        <div style="height: 300px; position: relative;">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <i class="fas fa-layer-group"></i> –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏
        </div>
        <div style="height: 300px; position: relative;">
            <canvas id="priorityChart"></canvas>
        </div>
    </div>
</div>

<!-- –¢–æ–ø –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤ –∏ –¢–∞–±–ª–∏—Ü–∞ -->
<div class="row">
    <div class="col-md-4">
        <div class="top-users-section">
            <div class="chart-header">
                <i class="fas fa-trophy"></i> –¢–æ–ø-5 –ê–∫—Ç–∏–≤–∏—Å—Ç–æ–≤
            </div>
            
            {% if active_users %}
                {% for user in active_users %}
                <div class="user-rank-item">
                    <div class="rank-num rank-{{ loop.index }}">{{ loop.index }}</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;">{{ user.username }}</div>
                        <div style="font-size:0.8rem; color:#888;">{{ user.total_points_added }} –∑–∞—è–≤–æ–∫</div>
                    </div>
                    <div style="font-weight:800; color:var(--primary-green);">
                        {{ user.points }} üü°
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4 text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            {% endif %}
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="table-container">
            <div class="chart-header" style="padding: 20px; background:white; margin:0;">
                <i class="fas fa-list"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if points %}
                            {% for point in points[:10] %}
                            <tr>
                                <td>
                                    <strong>{{ point.title }}</strong>
                                </td>
                                <td>
                                    <span class="badge-custom cat-{{ point.category if point.category in ['pollution','plants','water'] else 'other' }}">
                                        {{ point.category }}
                                    </span>
                                </td>
                                <td>
                                    {% if point.severity >= 5 %}
                                        <span style="color:var(--accent-red); font-weight:800;">–í—ã—Å–æ–∫–∏–π</span>
                                    {% elif point.severity >= 3 %}
                                        <span style="color:#F1C40F; font-weight:700;">–°—Ä–µ–¥–Ω–∏–π</span>
                                    {% else %}
                                        <span style="color:#27AE60;">–ù–∏–∑–∫–∏–π</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="status-{{ point.status }}">
                                        {{ '–†–µ—à–µ–Ω–æ' if point.status == 'completed' else '–í —Ä–∞–±–æ—Ç–µ' if point.status == 'in_progress' else '–ù–æ–≤–∞—è' }}
                                    </span>
                                </td>
                                <td>{{ point.created_at.strftime('%d.%m.%Y') }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Flask —á–µ—Ä–µ–∑ Jinja2
    const categoryData = {{ categories | tojson }};
    const priorityData = {{ priorities | tojson }};

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (Pie Chart)
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categoryData).length ? Object.keys(categoryData) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
            datasets: [{
                data: Object.keys(categoryData).length ? Object.values(categoryData) : [1],
                backgroundColor: [
                    '#E74C3C', // –ö—Ä–∞—Å–Ω—ã–π (–ú—É—Å–æ—Ä)
                    '#27AE60', // –ó–µ–ª–µ–Ω—ã–π (–†–∞—Å—Ç–µ–Ω–∏—è)
                    '#3498db', // –°–∏–Ω–∏–π (–í–æ–¥–∞)
                    '#F1C40F', // –ñ–µ–ª—Ç—ã–π (–ü–æ–ª–æ–º–∫–∞)
                    '#9b59b6', // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–ñ–∏–≤–æ—Ç–Ω—ã–µ)
                    '#95a5a6'  // –°–µ—Ä—ã–π (–î—Ä—É–≥–æ–µ)
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { usePointStyle: true, font: { family: 'Segoe UI' } } }
            }
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ (Bar Chart)
    const ctxPri = document.getElementById('priorityChart').getContext('2d');
    new Chart(ctxPri, {
        type: 'bar',
        data: {
            labels: ['–ù–∏–∑–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–í—ã—Å–æ–∫–∏–π', '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'],
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫',
                data: [
                    priorityData['–ù–∏–∑–∫–∏–π'] || 0,
                    priorityData['–°—Ä–µ–¥–Ω–∏–π'] || 0,
                    priorityData['–í—ã—Å–æ–∫–∏–π'] || 0,
                    priorityData['–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'] || 0
                ],
                backgroundColor: [
                    '#27AE60',
                    '#F1C40F',
                    '#e67e22',
                    '#E74C3C'
                ],
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}