{% extends "base.html" %}
{% block title %}–ú–æ–π –¥–∞—à–±–æ—Ä–¥{% endblock %}
{% block extra_css %}
<style>
    :root {
        --primary-green: #1B4B43;
        --bg-beige: #F2EFE4;
        --accent-red: #E74C3C;
        --accent-yellow: #F1C40F;
        --accent-blue: #2980b9;
        --border-thick: 2px solid #1B4B43;
        --radius-main: 12px;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .dashboard-page-header {
        background-color: var(--bg-beige);
        padding: 25px;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        margin-bottom: 30px;
        color: var(--primary-green);
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 0 rgba(27, 75, 67, 0.1);
    }
    
    .dashboard-page-header h1 {
        margin: 0;
        font-weight: 800;
        font-size: 1.8rem;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .dash-card {
        background: white;
        border-radius: var(--radius-main);
        border: var(--border-thick);
        margin-bottom: 25px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .dash-header {
        padding: 15px 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
        font-weight: 700;
        color: var(--primary-green);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1rem;
    }

    .dash-body {
        padding: 20px;
    }

    /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .profile-summary {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .profile-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid var(--primary-green);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        font-size: 2.5rem;
        color: var(--primary-green);
        flex-shrink: 0;
    }
    
    .profile-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-details h3 {
        margin: 0 0 5px 0;
        font-weight: 800;
        color: var(--primary-green);
    }

    .role-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 15px;
        font-weight: 700;
        text-transform: uppercase;
        margin-right: 5px;
    }
    .badge-admin { background: var(--accent-red); color: white; }
    .badge-worker { background: var(--accent-yellow); color: black; }
    .badge-city { background: var(--bg-beige); color: var(--primary-green); border: 1px solid var(--primary-green); }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è */
    .level-container {
        margin-top: 15px;
    }
    
    .level-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #666;
    }
    
    .progress-bar-bg {
        height: 10px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-yellow), #f39c12);
        border-radius: 10px;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∏—Ç–∫–∏ */
    .mini-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 25px;
    }
    
    .mini-stat {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
    }
    
    .mini-stat:hover {
        transform: translateY(-3px);
        border-color: var(--primary-green);
    }
    
    .mini-stat-val {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--primary-green);
    }
    
    .mini-stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #888;
        font-weight: 700;
    }

    /* –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .activity-feed {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: white;
        border: 1px solid #eee;
        border-radius: 8px;
        transition: background 0.2s;
        text-decoration: none;
        color: inherit;
    }
    
    .activity-item:hover {
        background: #f9f9f9;
        border-color: #ccc;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .icon-problem { background: #ffebee; color: var(--accent-red); }
    .icon-task { background: #e3f2fd; color: var(--accent-blue); }
    .icon-badge { background: #fff8e1; color: var(--accent-yellow); }

    .activity-content { flex: 1; }
    
    .activity-title {
        font-weight: 700;
        font-size: 0.95rem;
        margin-bottom: 2px;
    }
    
    .activity-date {
        font-size: 0.8rem;
        color: #888;
    }
    
    .activity-points {
        font-weight: 800;
        color: var(--primary-green);
        font-size: 0.9rem;
    }

    /* –°–µ—Ç–∫–∞ –±–µ–π–¥–∂–µ–π */
    .badges-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 15px;
        justify-items: center;
    }
    
    .badge-item {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--bg-beige);
        border: 2px solid var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--primary-green);
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .badge-item:hover {
        transform: scale(1.1);
        background: var(--primary-green);
        color: white;
    }

    /* –ú–æ–∏ –∑–∞–¥–∞—á–∏ */
    .my-task-card {
        border-left: 4px solid var(--primary-green);
        background: #fff;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 10px;
    }
    
    .my-task-card.high { border-left-color: var(--accent-yellow); }
    .my-task-card.critical { border-left-color: var(--accent-red); }
    
    .btn-sm-action {
        padding: 4px 10px;
        font-size: 0.75rem;
        border-radius: 15px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        margin-top: 8px;
    }
    
    .btn-done { background: #27AE60; color: white; }

    @media (max-width: 768px) {
        .row { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-page-header">
    <i class="fas fa-columns fa-2x"></i>
    <div>
        <h1>–ú–æ–π –î–∞—à–±–æ—Ä–¥</h1>
        <div style="font-size: 0.9rem; opacity: 0.8;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</div>
    </div>
</div>

<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-md-8">
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="dash-card">
            <div class="dash-body">
                <div class="profile-summary">
                    <div class="profile-avatar-large">
                        {% if user.avatar %}
                            <img src="{{ user.avatar }}" alt="Avatar">
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div class="profile-details" style="flex: 1;">
                        <h3>{{ user.username }}</h3>
                        <div style="margin-bottom: 10px;">
                            <span class="role-badge badge-city">{{ user.city }}</span>
                            {% if user.is_worker %}
                                <span class="role-badge badge-worker">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>
                            {% endif %}
                            {% if user.is_admin %}
                                <span class="role-badge badge-admin">–ê–¥–º–∏–Ω</span>
                            {% endif %}
                        </div>
                        
                        <!-- –£—Ä–æ–≤–µ–Ω—å -->
                        <div class="level-container">
                            <div class="level-info">
                                <span>–£—Ä–æ–≤–µ–Ω—å {{ user.level }}</span>
                                <span>{{ user.experience }} / {{ user.level * 100 }} XP</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: {{ (user.experience / (user.level * 100) * 100) if user.level * 100 > 0 else 0 }}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="mini-stats-grid">
                    <div class="mini-stat">
                        <div class="mini-stat-val">{{ user.points }}</div>
                        <div class="mini-stat-label">–ë–∞–ª–∞–Ω—Å –§–ú</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-val" style="color: var(--accent-blue);">{{ user.total_reports }}</div>
                        <div class="mini-stat-label">–ó–∞—è–≤–æ–∫</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-stat-val" style="color: var(--accent-red);">{{ user.total_completed }}</div>
                        <div class="mini-stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
        <div class="dash-card">
            <div class="dash-header">
                <span><i class="fas fa-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</span>
            </div>
            <div class="dash-body">
                {% if recent_points %}
                    <div class="activity-feed">
                        {% for point in recent_points %}
                        <a href="#" class="activity-item">
                            <div class="activity-icon icon-problem">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: {{ point.title }}</div>
                                <div class="activity-date">{{ point.created_at.strftime('%d.%m.%Y –≤ %H:%M') }}</div>
                            </div>
                            <div class="activity-points">+15 üü°</div>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="far fa-clock fa-2x mb-2"></i>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ!</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-md-4">
        
        <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
        <div class="dash-card">
            <div class="dash-header">
                <span><i class="fas fa-award"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span>
                <span class="badge bg-secondary">{{ user_badges|length }}</span>
            </div>
            <div class="dash-body">
                {% if user_badges %}
                    <div class="badges-container">
                        {% for badge in user_badges %}
                        <div class="badge-item" title="{{ badge.name }}">
                            <i class="fas {{ badge.icon }}"></i>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <p class="mb-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–Ω–∞—á–∫–æ–≤</p>
                        <small>–ü—Ä–æ—è–≤–ª—è–π—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏—Ö!</small>
                    </div>
                {% endif %}
                
                <!-- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ -->
                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                    <small style="color: #999; font-weight: 700; text-transform: uppercase;">–°–ª–µ–¥—É—é—â–∏–µ —Ü–µ–ª–∏:</small>
                    <ul style="list-style: none; padding: 0; font-size: 0.9rem; margin-top: 5px;">
                        <li style="margin-bottom: 5px; color: #555;"><i class="fas fa-lock" style="color:#ccc; margin-right: 5px;"></i> 10 –ø—Ä–æ–±–ª–µ–º (–†–µ–ø–æ—Ä—Ç–µ—Ä)</li>
                        <li style="margin-bottom: 5px; color: #555;"><i class="fas fa-lock" style="color:#ccc; margin-right: 5px;"></i> 5 —Ä–µ—à–µ–Ω–∏–π (–ú–∞—Å—Ç–µ—Ä)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–∏ –∑–∞–¥–∞—á–∏ -->
        {% if user_tasks %}
        <div class="dash-card">
            <div class="dash-header" style="background: #fff8e1;">
                <span style="color: var(--accent-yellow);"><i class="fas fa-tasks"></i> –í —Ä–∞–±–æ—Ç–µ</span>
            </div>
            <div class="dash-body">
                {% for task in user_tasks %}
                <div class="my-task-card {{ 'critical' if task.priority == '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π' else 'high' if task.priority == '–í—ã—Å–æ–∫–∏–π' }}">
                    <div style="font-weight: 700; font-size: 0.95rem;">{{ task.title }}</div>
                    <div style="font-size: 0.8rem; color: #666; margin: 3px 0;">{{ task.description[:50] }}...</div>
                    <button class="btn-sm-action btn-done" onclick="completeTaskDashboard({{ task.id }})">
                        <i class="fas fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="dash-card">
            <div class="dash-header">
                <span><i class="fas fa-chart-area"></i> –î–∏–Ω–∞–º–∏–∫–∞</span>
            </div>
            <div class="dash-body">
                <canvas id="userProgressChart" height="200"></canvas>
            </div>
        </div>
        
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const ctx = document.getElementById('userProgressChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
            datasets: [{
                label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                data: [5, 15, 10, 25, 20, 35, {{ user.experience % 100 }}], // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
                borderColor: '#1B4B43',
                backgroundColor: 'rgba(27, 75, 67, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    async function completeTaskDashboard(taskId) {
        if(!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) return;
        
        try {
            const response = await fetch(`/api/problems/${taskId}/complete`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if(data.status === 'success') {
                alert('–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã.');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        } catch(e) {
            console.error(e);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        }
    }
</script>
{% endblock %}