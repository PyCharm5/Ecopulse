<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Профкоманды ФМ{% endblock %}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (Карты) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Основная цветовая схема */
        :root {
            --primary-green: #1B4B43;  /* Темно-зеленый (основной) */
            --bg-beige: #F2EFE4;       /* Светло-бежевый (фон) */
            --accent-red: #E74C3C;     /* Акцентный красный */
            --accent-yellow: #F1C40F;  /* Акцентный желтый (для баллов) */
            --accent-blue: #2980b9;    /* Акцентный синий */
            --radius-main: 12px;       /* Закругление блоков */
            --border-thick: 2px solid #1B4B43;
        }
		
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
        }
        
        /* --- ШАПКА САЙТА --- */
        .main-header {
            background-color: var(--bg-beige);
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #dcdcdc;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Логотип */
        .logo {
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .logo span { font-style: italic; }
        
        /* Навигация */
        .nav-center {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-link-custom {
            text-decoration: none;
            color: var(--primary-green);
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .nav-link-custom:hover {
            background-color: rgba(27, 75, 67, 0.05);
        }
        
        /* Правая часть шапки */
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .currency-badge {
            background: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Выпадающий список городов */
        .city-wrapper {
            position: relative;
        }

        .city-dropdown {
            position: absolute;
            top: 45px;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 280px;
            display: none;
            z-index: 2000;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .city-dropdown-header {
            padding: 12px 15px;
            background: #eee;
            font-weight: 700;
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .city-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .city-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.2s;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
        }

        .city-item:hover {
            background: var(--bg-beige);
            color: var(--primary-green);
        }

        .city-item.active {
            background: var(--bg-beige);
            font-weight: 800;
            color: var(--primary-green);
        }
        
        /* Контейнеры контента */
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            width: 100%;
            flex: 1;
        }

        /* Специальный контейнер для карты (на весь экран) */
        .map-container {
            height: calc(100vh - 70px);
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Всплывающие уведомления */
        .alert-container {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 9999;
            width: 350px;
        }
        
        .alert {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: none;
            border-left: 5px solid;
        }
        
        .alert-success { border-left-color: var(--accent-green); }
        .alert-danger { border-left-color: var(--accent-red); }
        
        /* Адаптив */
        @media (max-width: 768px) {
            .main-header { padding: 0 15px; }
            .nav-link-custom span { display: none; } /* Скрываем текст меню на мобильных */
            .nav-link-custom i { font-size: 1.2rem; }
            .city-dropdown { left: -50px; }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- ШАПКА -->
    <header class="main-header">
        <!-- Логотип -->
        <a href="{{ url_for('index') }}" class="logo">
            <i class="fas fa-leaf"></i>
            Профкоманды <span>ФМ</span>
        </a>
        
        <!-- Центральное меню -->
        <nav class="nav-center">
            <!-- Выбор города -->
            <div class="city-wrapper">
                <div class="nav-link-custom" onclick="toggleCities()" id="cityBtn">
                    <i class="fas fa-map-marker-alt"></i> 
                    <span id="currentCityName">Киселевск</span> 
                    <i class="fas fa-chevron-down" style="font-size:0.8em; margin-left:5px;"></i>
                </div>
                <div class="city-dropdown" id="cityDropdown">
                    <div class="city-dropdown-header">Выберите город присутствия</div>
                    <div class="city-list" id="cityList">
                        <!-- Список городов генерируется JS -->
                    </div>
                </div>
            </div>
            
            <a href="{{ url_for('index') }}" class="nav-link-custom" title="Карта">
                <i class="far fa-map"></i> <span>Карта</span>
            </a>
            <a href="{{ url_for('tasks') }}" class="nav-link-custom" title="Задания">
                <i class="fas fa-tasks"></i> <span>Задания</span>
            </a>
            <a href="{{ url_for('rating') }}" class="nav-link-custom" title="Рейтинг">
                <i class="fas fa-trophy"></i> <span>Рейтинг</span>
            </a>
            <a href="{{ url_for('education') }}" class="nav-link-custom" title="Обучение">
                <i class="fas fa-graduation-cap"></i> <span>Обучение</span>
            </a>
        </nav>

        <!-- Правая часть (Профиль) -->
        <div class="header-right">
            <a href="{{ url_for('shop') }}" class="currency-badge" title="Магазин">
                <span id="currency-amount">{{ current_user.points if current_user else 0 }}</span> 
                <i class="fas fa-coins" style="color: var(--accent-yellow);"></i>
            </a>
            
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('profile') }}" class="nav-link-custom" title="Профиль">
                    <i class="fas fa-user-circle fa-lg"></i>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-link-custom" style="color:var(--accent-red);" title="Выход">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
                
                <!-- Ссылка на админку (если админ) -->
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin_panel') }}" class="nav-link-custom" style="background:var(--primary-green); color:white;" title="Админка">
                    <i class="fas fa-cogs"></i>
                </a>
                {% endif %}
            {% else %}
                <a href="{{ url_for('login') }}" class="nav-link-custom" style="font-weight:800;">Войти</a>
            {% endif %}
        </div>
    </header>

    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <!-- Используем map-container для карт, page-container для остальных страниц -->
    <main class="{% if request.endpoint == 'index' or request.endpoint == 'map' %}map-container{% else %}page-container{% endif %}">
        
        <!-- Flash Сообщения -->
        <div class="alert-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                            <strong>{{ 'Ошибка!' if category == 'error' else 'Успешно!' }}</strong> {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        {% block content %}{% endblock %}
    </main>

    <!-- СКРИПТЫ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Список городов с координатами для переключения
        // Используем реальные координаты центров городов
        const cities = [
            {name: "Киселевск", lat: 53.9925, lng: 86.6669}, // Кемеровская обл
            {name: "Ковдор", lat: 67.5661, lng: 30.4758},    // Мурманская обл (ЕвроХим)
            {name: "Невинномысск", lat: 44.6333, lng: 41.9333},
            {name: "Новомосковск", lat: 54.0167, lng: 38.3000},
            {name: "Белореченск", lat: 44.7667, lng: 39.8667},
            {name: "Кингисепп", lat: 59.3667, lng: 28.6000},
            {name: "Усолье-Сибирское", lat: 52.7500, lng: 103.6500},
            {name: "Ленинск-Кузнецкий", lat: 54.6667, lng: 86.1667},
            {name: "Москва", lat: 55.7558, lng: 37.6176} // Для тестов
        ];

        // Управление выпадающим списком
        function toggleCities() {
            const el = document.getElementById('cityDropdown');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }

        // Логика выбора города
        function selectCity(name, lat, lng) {
            // Сохраняем в localStorage
            localStorage.setItem('selectedCity', name);
            localStorage.setItem('cityLat', lat);
            localStorage.setItem('cityLng', lng);
            
            // Обновляем текст в шапке
            document.getElementById('currentCityName').innerText = name;
            document.getElementById('cityDropdown').style.display = 'none';
            
            // Если мы на карте или в админке - перезагружаем страницу, 
            // чтобы скрипты подхватили новые координаты
            if(window.location.pathname === '/' || window.location.pathname === '/admin' || window.location.pathname === '/analytics') {
                window.location.reload();
            } else {
                // Иначе просто показываем уведомление
                // (можно добавить красивый тост, но пока алерт для надежности)
                // alert('Город изменен на ' + name); 
            }
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Восстанавливаем сохраненный город или ставим дефолт
            const savedCity = localStorage.getItem('selectedCity') || 'Киселевск';
            const savedLat = localStorage.getItem('cityLat');
            
            // Если координат нет в хранилище (первый запуск), сохраняем дефолтные
            if (!savedLat) {
                localStorage.setItem('cityLat', 53.9925);
                localStorage.setItem('cityLng', 86.6669);
            }
            
            document.getElementById('currentCityName').innerText = savedCity;
            
            // Генерируем список городов
            const list = document.getElementById('cityList');
            list.innerHTML = '';
            
            cities.forEach(c => {
                const div = document.createElement('div');
                div.className = `city-item ${c.name === savedCity ? 'active' : ''}`;
                
                // Добавляем галочку для активного города
                const check = c.name === savedCity ? '<i class="fas fa-check"></i>' : '';
                
                div.innerHTML = `<span>${c.name}</span> ${check}`;
                div.onclick = () => selectCity(c.name, c.lat, c.lng);
                list.appendChild(div);
            });
        });
        
        // Закрыть меню при клике вне его области
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#cityBtn') && !e.target.closest('#cityDropdown')) {
                document.getElementById('cityDropdown').style.display = 'none';
            }
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>